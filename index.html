<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maru-Text-to-Speech</title>
    <meta name="description" content="シンプルで使いやすいテキスト読み上げツール">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <meta name="theme-color" content="#3B82F6">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f2937;
        }

        .container {
            background: #ffffff;
            border-radius: 6px;
            padding: 32px;
            max-width: 640px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        h1 {
            color: #1f2937;
            margin-bottom: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 28px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 24px;
            background: #ffffff;
            color: #1f2937;
            font-family: inherit;
        }

        /* スマートフォン向けテキストエリア最適化 */
        @media (max-width: 768px) {
            textarea {
                min-height: 120px;
                padding: 16px;
                font-size: 16px; /* iOS Safariでズームを防ぐため */
                border-radius: 8px;
                margin-bottom: 20px;
            }
        }

        textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        textarea::placeholder {
            color: #9ca3af;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 24px;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #ffffff;
            color: #1f2937;
            font-size: 16px;
        }

        select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            margin: 32px 0;
        }

        button {
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-out;
            font-weight: 500;
        }

        .btn-play-pause {
            background: #2563eb;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.15);
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }

        .btn-play-pause.playing {
            background: #f59e0b;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.15);
        }

        .btn-play-pause:hover:not(:disabled) {
            background: #3b82f6;
        }

        .btn-play-pause.playing:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-play-pause:active:not(:disabled) {
            background: #1d4ed8;
        }

        .btn-play-pause.playing:active:not(:disabled) {
            background: #b45309;
        }

        .btn-play-pause:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .btn-icon {
            transition: opacity 0.2s ease-out;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-icon.hidden {
            opacity: 0;
        }

        .btn-stop {
            background: #ffffff;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-stop:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .btn-stop:disabled {
            opacity: 0.5;
            cursor: default;
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status {
            text-align: center;
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .language-info {
            background: #f9fafb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            border-left: 3px solid #2563eb;
        }

        .language-info span {
            font-weight: 500;
            color: #1f2937;
            font-size: 14px;
        }

        .voice-quality {
            color: #ffd700;
        }

        .pitch-control {
            width: 100%;
            margin-top: 10px;
        }

        .btn-pause {
            background: #ffffff;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-pause:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .flag-icon {
            margin-left: 8px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 0 12px;
            height: 32px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            background: #ffffff;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-out;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* スマートフォン向けプリセットボタン最適化 */
        @media (max-width: 768px) {
            .preset-btn {
                padding: 0 16px;
                height: 40px;
                min-height: 40px;
                font-size: 14px;
                min-width: 48px;
            }
        }

        .preset-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .preset-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 8px;
            display: block;
            font-size: 13px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            margin: 8px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #2563eb;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #2563eb;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .slider-value {
            background: #2563eb;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            min-width: 36px;
            text-align: center;
        }

        .skip-btn {
            width: 48px;
            height: 40px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            position: relative;
        }

        .skip-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .skip-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .skip-btn svg {
            width: 18px;
            height: 18px;
            stroke: #374151;
            stroke-width: 3px;
            fill: #374151;
        }

        .skip-text {
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            margin-top: 2px;
            line-height: 1;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            background: #f9fafb;
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            .buttons {
                margin: 24px 0;
            }

            .control-buttons {
                gap: 12px;
                padding: 16px 20px;
            }

            .btn-play-pause {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }

            .skip-btn {
                width: 52px;
                height: 44px;
                min-height: 44px;
            }

            .skip-btn svg {
                width: 18px;
                height: 18px;
            }

            .skip-text {
                font-size: 11px;
                margin-top: 2px;
            }

            .btn-stop {
                width: 44px;
                height: 44px;
                min-height: 44px;
            }

            .btn-stop svg {
                width: 16px;
                height: 16px;
            }
        }

        .examples-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-top: 32px;
            border: 1px solid #e5e7eb;
        }

        .examples-section h3 {
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .examples-description {
            color: #6b7280;
            font-size: 13px;
            text-align: center;
            margin-bottom: 24px;
        }

        .examples-category {
            margin-bottom: 24px;
        }

        .examples-category:last-child {
            margin-bottom: 0;
        }

        .examples-category h4 {
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .example-group {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }

        .example-group h5 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .example-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px 0;
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .example-btn:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
        }

        .example-btn:active {
            background: #dbeafe;
        }

        .example-btn.clicked {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        @media (max-width: 640px) {
            .examples-grid {
                grid-template-columns: 1fr;
            }

            .examples-section {
                padding: 20px;
                margin-top: 24px;
            }
        }

        /* 履歴機能のスタイル */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* スマートフォン向けヘッダー最適化 */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                padding: 1rem 0.75rem;
                margin-bottom: 1.5rem;
            }

            .header h1 {
                margin: 0 0 0.75rem 0;
                font-size: 1.5rem;
                line-height: 1.2;
            }
        }

        .history-btn {
            padding: 0.75rem 1.25rem;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            min-height: 44px;
            min-width: 80px;
            justify-content: center;
        }

        /* スマートフォン向けボタン最適化 */
        @media (max-width: 768px) {
            .history-btn {
                padding: 0.875rem 1.5rem;
                font-size: 1rem;
                min-height: 48px;
                min-width: 120px;
            }
        }

        .history-btn:hover {
            background: #2563EB;
            transform: translateY(-1px);
        }

        .history-btn:active {
            transform: translateY(0);
        }

        /* 履歴モーダル */
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .history-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .history-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .history-modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .history-item-text {
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .history-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .practice-btn, .delete-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .practice-btn {
            background: #3B82F6;
            color: white;
        }

        .practice-btn:hover {
            background: #2563EB;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .clear-all-btn {
            width: 100%;
            padding: 0.75rem;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        .clear-all-btn:hover {
            background: #4b5563;
        }

        .history-empty {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .history-empty-sub {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-item-lang {
            font-size: 0.8rem;
            font-weight: bold;
            color: #3B82F6;
        }

        .history-item-date {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .history-item-params {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0.5rem 0;
        }

        .history-practice-btn, .history-delete-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-practice-btn {
            background: #3B82F6;
            color: white;
        }

        .history-practice-btn:hover {
            background: #2563EB;
        }

        .history-delete-btn {
            background: #ef4444;
            color: white;
        }

        .history-delete-btn:hover {
            background: #dc2626;
        }

        .empty-history {
            text-align: center;
            color: #6b7280;
            padding: 3rem 1rem;
        }

        .empty-history-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-history-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-history-subtext {
            font-size: 0.9rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Maru-Text-to-Speech</h1>
            <button id="historyBtn" class="history-btn">
                📚 履歴
            </button>
        </div>
        
        <textarea id="textInput" placeholder="読み上げたいテキストを入力してください..."></textarea>

        <div id="languageInfo" class="language-info" style="display: none;">
            <span>検出言語:</span> <span id="detectedLanguage"></span>
        </div>

        <div class="controls">
            <select id="voiceSelect">
                <option value="">音声を選択...</option>
            </select>

            <div class="control-group">
                <label class="control-label">速度: <span id="rateValue">1.0</span>x</label>
                <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1">
                <div class="preset-buttons">
                    <button class="preset-btn" data-rate="0.75">0.75x</button>
                    <button class="preset-btn active" data-rate="1.0">1.0x</button>
                    <button class="preset-btn" data-rate="1.25">1.25x</button>
                    <button class="preset-btn" data-rate="1.5">1.5x</button>
                    <button class="preset-btn" data-rate="1.75">1.75x</button>
                    <button class="preset-btn" data-rate="2.0">2.0x</button>
                </div>
            </div>

        </div>
        
        <div class="buttons">
            <div class="control-buttons">
                <button id="skipBackBtn" class="skip-btn" title="15秒戻る">
                    <svg viewBox="0 0 24 24">
                        <path d="M11 17l-5-5 5-5v10z" fill="#374151"/>
                        <path d="M18 17l-5-5 5-5v10z" fill="#374151"/>
                    </svg>
                    <span class="skip-text">15</span>
                </button>
                <button id="playPauseBtn" class="btn-play-pause">
                    <svg class="btn-icon play-icon" viewBox="0 0 24 24" fill="white">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="btn-icon pause-icon hidden" viewBox="0 0 24 24" fill="white">
                        <path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"/>
                    </svg>
                </button>
                <button id="skipForwardBtn" class="skip-btn" title="15秒進む">
                    <svg viewBox="0 0 24 24">
                        <path d="M13 7l5 5-5 5V7z" fill="#374151"/>
                        <path d="M6 7l5 5-5 5V7z" fill="#374151"/>
                    </svg>
                    <span class="skip-text">15</span>
                </button>
                <button id="stopBtn" class="btn-stop" title="停止">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="status" class="status">準備完了</div>

        <!-- デバッグ表示（音声情報） -->
        <div id="voiceDebugInfo" class="voice-debug-info" style="display: none;">
            <small style="color: #666; font-size: 12px;">
                🎤 音声: <span id="selectedVoiceName">未選択</span><br>
                ⚡ 速度: <span id="currentSpeedDebug">1.0</span>
            </small>
        </div>

        <div class="examples-section">
            <h3>試してみよう - Example Phrases</h3>
            <p class="examples-description">クリックして例文を試す - Click to try example phrases</p>

            <div class="examples-category">
                <h4>🇺🇸 English</h4>
                <div class="examples-grid">
                    <div class="example-group">
                        <h5>Greetings & Introduction</h5>
                        <button class="example-btn" data-text="Hello! My name is Sarah. Nice to meet you.">Hello! My name is Sarah. Nice to meet you.</button>
                        <button class="example-btn" data-text="How are you doing today? I hope you're having a great day!">How are you doing today? I hope you're having a great day!</button>
                    </div>

                    <div class="example-group">
                        <h5>Daily Conversation</h5>
                        <button class="example-btn" data-text="Could you tell me where the nearest station is?">Could you tell me where the nearest station is?</button>
                        <button class="example-btn" data-text="I'd like to have a coffee, please. Do you have any recommendations?">I'd like to have a coffee, please. Do you have any recommendations?</button>
                        <button class="example-btn" data-text="The weather is beautiful today, isn't it?">The weather is beautiful today, isn't it?</button>
                    </div>

                    <div class="example-group">
                        <h5>Business</h5>
                        <button class="example-btn" data-text="Thank you for your email. I'll get back to you by tomorrow.">Thank you for your email. I'll get back to you by tomorrow.</button>
                        <button class="example-btn" data-text="Let's schedule a meeting for next week. When are you available?">Let's schedule a meeting for next week. When are you available?</button>
                    </div>
                </div>
            </div>

            <div class="examples-category">
                <h4>🇯🇵 日本語</h4>
                <div class="examples-grid">
                    <div class="example-group">
                        <h5>ビジネス</h5>
                        <button class="example-btn" data-text="こんにちは。本日はお時間をいただき、ありがとうございます。">こんにちは。本日はお時間をいただき、ありがとうございます。</button>
                        <button class="example-btn" data-text="明日の会議の資料を送らせていただきます。">明日の会議の資料を送らせていただきます。</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 履歴モーダル -->
        <div id="historyModal" class="history-modal">
            <div class="history-modal-content">
                <div class="history-modal-header">
                    <h2 class="history-modal-title">📚 読み上げ履歴</h2>
                    <button id="closeHistoryModal" class="close-btn">&times;</button>
                </div>
                <div class="history-modal-body">
                    <div id="historyList"></div>
                    <button id="clearAllHistoryBtn" class="clear-all-btn" style="display: none;">
                        🗑️ すべて削除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 音声合成の初期化
        const synth = window.speechSynthesis;
        let voices = [];
        let currentUtterance = null;
        let isPaused = false;
        let currentText = '';
        let currentPosition = 0;
        let isPlaying = false;

        // リアルタイム変更用の変数
        let originalText = ''; // 元のテキスト（変更検知用）
        let currentSentenceIndex = 0; // 現在の文章インデックス（日本語分割用）
        let allSentences = []; // 分割された全文章（日本語用）
        let isRealTimeChanging = false; // リアルタイム変更中フラグ

        // デバイス判定機能
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);

        // デバッグ表示用の要素を追加
        let selectedVoiceInfo = null;

        // 履歴管理機能
        function saveToHistory(text, language, rate) {
            try {
                const history = JSON.parse(localStorage.getItem('ttsHistory') || '[]');
                const entry = {
                    text: text,
                    language: language,
                    rate: rate,
                    timestamp: new Date().toISOString()
                };

                // 重複チェック（同じテキストが既に存在する場合は削除してから追加）
                const filteredHistory = history.filter(item => item.text !== text);
                filteredHistory.unshift(entry);

                // 最大50件まで保存
                if (filteredHistory.length > 50) {
                    filteredHistory.splice(50);
                }

                localStorage.setItem('ttsHistory', JSON.stringify(filteredHistory));
                console.log('履歴に保存しました:', entry);
            } catch (error) {
                console.error('履歴保存エラー:', error);
            }
        }

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('ttsHistory') || '[]');
            } catch (error) {
                console.error('履歴取得エラー:', error);
                return [];
            }
        }

        function clearHistory() {
            try {
                localStorage.removeItem('ttsHistory');
                console.log('履歴をクリアしました');
            } catch (error) {
                console.error('履歴クリアエラー:', error);
            }
        }

        function deleteHistoryItem(index) {
            try {
                const history = getHistory();
                history.splice(index, 1);
                localStorage.setItem('ttsHistory', JSON.stringify(history));
                console.log('履歴項目を削除しました');
                displayHistory(); // リストを更新
            } catch (error) {
                console.error('履歴削除エラー:', error);
            }
        }

        function displayHistory() {
            const historyList = document.getElementById('historyList');
            const clearAllBtn = document.getElementById('clearAllHistoryBtn');
            const history = getHistory();

            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="history-empty">
                        <p>📝 まだ履歴がありません</p>
                        <p class="history-empty-sub">テキストを読み上げると履歴が表示されます</p>
                    </div>
                `;
                if (clearAllBtn) clearAllBtn.style.display = 'none';
                return;
            }

            // 履歴がある場合はクリアボタンを表示
            if (clearAllBtn) clearAllBtn.style.display = 'block';

            historyList.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const languageFlag = item.language === 'ja' ? '🇯🇵' : '🇺🇸';
                const truncatedText = item.text.length > 80 ? item.text.substring(0, 80) + '...' : item.text;

                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-item-lang">${languageFlag} ${item.language.toUpperCase()}</span>
                            <span class="history-item-date">${dateStr}</span>
                        </div>
                        <div class="history-item-text">${truncatedText}</div>
                        <div class="history-item-params">
                            ⚡ 速度: ${item.rate}
                        </div>
                        <div class="history-item-actions">
                            <button class="history-practice-btn" onclick="practiceHistoryItem(${index})">
                                🎯 練習する
                            </button>
                            <button class="history-delete-btn" onclick="deleteHistoryItem(${index})">
                                🗑️ 削除
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function practiceHistoryItem(index) {
            try {
                const history = getHistory();
                if (index >= 0 && index < history.length) {
                    const item = history[index];

                    // テキストエリアに復元
                    textInput.value = item.text;

                    // パラメータを復元
                    rateRange.value = item.rate;
                    rateValue.textContent = item.rate;

                    // 言語検出をトリガー
                    const event = new Event('input', { bubbles: true });
                    textInput.dispatchEvent(event);

                    // モーダルを閉じる
                    closeHistoryModal();

                    // テキストエリアにフォーカス
                    setTimeout(() => {
                        textInput.focus();
                        textInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);

                    console.log('履歴項目を復元しました:', item);
                }
            } catch (error) {
                console.error('履歴復元エラー:', error);
            }
        }

        function openHistoryModal() {
            displayHistory();
            document.getElementById('historyModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // スクロール防止
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
            document.body.style.overflow = ''; // スクロール復元
        }

        // リアルタイム変更用ユーティリティ関数
        function handleRealtimeParamChange() {
            if (!isPlaying || isPaused || isRealTimeChanging) return;

            isRealTimeChanging = true;

            // スムーズな切り替えのため、最小限の表示更新
            const originalStatus = status.textContent;
            status.textContent = '更新中...';

            // 現在の読み上げを停止
            synth.cancel();

            // 50ms後に新しいパラメータで再開（スムーズな切り替え）
            setTimeout(() => {
                if (allSentences.length > 0 && currentSentenceIndex < allSentences.length) {
                    // 日本語の場合：現在の文章から再開
                    continueJapaneseSpeech();
                } else {
                    // 英語その他の場合：最初から再開
                    continueNormalSpeech();
                }

                // 切り替え完了後、適切なステータスに戻す
                setTimeout(() => {
                    if (isPlaying) {
                        status.textContent = '読み上げ中...';
                    }
                    isRealTimeChanging = false;
                }, 100);
            }, 50);
        }

        function continueJapaneseSpeech() {
            const detectedLang = detectLanguage(originalText);
            if (detectedLang === 'ja') {
                speakJapaneseFromIndex(currentSentenceIndex);
            }
        }

        function continueNormalSpeech() {
            const text = textInput.value.trim();
            if (!text) return;

            const detectedLang = detectLanguage(text);
            let processedText = text;

            if (detectedLang === 'en') {
                processedText = preprocessEnglishText(text);
            } else if (detectedLang === 'ja') {
                processedText = preprocessJapaneseText(text);
            }

            const utterance = new SpeechSynthesisUtterance(processedText);
            currentUtterance = utterance;

            // 音声選択
            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== '' && voices[selectedIndex]) {
                utterance.voice = voices[selectedIndex];
            } else {
                const optimalVoice = getOptimalVoice(detectedLang);
                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                }
            }

            // パラメータ設定（モバイル対応）
            const optimizedParams = getMobileOptimizedParams(detectedLang, rateRange.value);
            utterance.rate = optimizedParams.rate;
            utterance.pitch = 1.0;
            utterance.volume = optimizedParams.volume;

            utterance.onstart = () => {
                status.textContent = '読み上げ中...';
            };

            utterance.onend = () => {
                status.textContent = '読み上げ完了';
                resetButtons();
            };

            utterance.onerror = () => {
                status.textContent = 'エラーが発生しました';
                resetButtons();
            };

            synth.speak(utterance);
        }

        // ボタンアイコン切り替え機能
        function updatePlayPauseButton(playing) {
            if (playing) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                playPauseBtn.classList.add('playing');
                isPlaying = true;
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playPauseBtn.classList.remove('playing');
                isPlaying = false;
            }
        }

        // DOM要素の取得
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateRange = document.getElementById('rateRange');
        const rateValue = document.getElementById('rateValue');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.querySelector('.play-icon');
        const pauseIcon = document.querySelector('.pause-icon');
        const stopBtn = document.getElementById('stopBtn');
        const skipBackBtn = document.getElementById('skipBackBtn');
        const skipForwardBtn = document.getElementById('skipForwardBtn');
        const status = document.getElementById('status');
        const languageInfo = document.getElementById('languageInfo');
        const detectedLanguage = document.getElementById('detectedLanguage');
        
        // 言語検出関数
        function detectLanguage(text) {
            const japanesePattern = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
            const englishPattern = /^[a-zA-Z0-9\s.,!?;:"'()\-\[\]{}@#$%^&*+=<>\/\\`~]*$/;

            if (japanesePattern.test(text)) {
                return 'ja';
            } else if (englishPattern.test(text.trim())) {
                return 'en';
            } else {
                // 混在または不明な場合は日本語をデフォルト
                return 'ja';
            }
        }

        // 英語テキストの前処理関数
        function preprocessEnglishText(text) {
            let processed = text;

            // 略語の展開
            const abbreviations = {
                'Mr.': 'Mister',
                'Mrs.': 'Misses',
                'Ms.': 'Miss',
                'Dr.': 'Doctor',
                'Prof.': 'Professor',
                'St.': 'Street',
                'Ave.': 'Avenue',
                'Blvd.': 'Boulevard',
                'Inc.': 'Incorporated',
                'Co.': 'Company',
                'Ltd.': 'Limited',
                'etc.': 'etcetera',
                'vs.': 'versus',
                'e.g.': 'for example',
                'i.e.': 'that is',
                'U.S.': 'United States',
                'U.K.': 'United Kingdom',
                'U.S.A.': 'United States of America',
                'www.': 'W W W dot',
                '.com': ' dot com',
                '.org': ' dot org',
                '.net': ' dot net',
                '@': ' at '
            };

            // 略語を展開
            Object.keys(abbreviations).forEach(abbr => {
                const regex = new RegExp('\\b' + abbr.replace('.', '\\.'), 'gi');
                processed = processed.replace(regex, abbreviations[abbr]);
            });

            // URLとメールアドレスの処理
            processed = processed.replace(/https?:\/\//gi, 'H T T P ');
            processed = processed.replace(/\.([a-z]{2,4})\b/gi, ' dot $1');

            // 数字の処理
            processed = processed.replace(/(\d+)\.(\d+)/g, '$1 point $2');

            // SSMLサポートのチェックと文の区切り改善
            if (typeof window !== 'undefined' && window.speechSynthesis) {
                // モバイル専用の強化処理
                if (isMobile) {
                    // スマホではより長い間を追加（自然な読み上げのため）
                    processed = processed.replace(/([.!?])\s+/g, '$1...... '); // 長めの間
                    processed = processed.replace(/,\s+/g, ', .. '); // カンマ後に短い間
                    processed = processed.replace(/;\s+/g, '; ... '); // セミコロン後に間
                    processed = processed.replace(/:\s+/g, ': .. '); // コロン後に短い間

                    // 長い文を分割（50-70文字で区切り）
                    processed = splitLongSentencesForMobile(processed);
                } else {
                    // PC用の既存処理
                    processed = processed.replace(/([.!?])\s+/g, '$1... ');
                    processed = processed.replace(/,\s+/g, ', ');
                    processed = processed.replace(/;\s+/g, '; ');
                }
            }

            return processed;
        }

        // スマホ用：長い文章を自然に分割する関数
        function splitLongSentencesForMobile(text) {
            const sentences = text.split(/([.!?]+\s*)/);
            let processedSentences = [];

            for (let i = 0; i < sentences.length; i += 2) {
                const sentence = sentences[i];
                const punctuation = sentences[i + 1] || '';

                if (sentence && sentence.length > 70) {
                    // 長い文を分割
                    const parts = [];
                    let currentPart = '';
                    const words = sentence.split(' ');

                    for (const word of words) {
                        if (currentPart.length + word.length + 1 <= 60) {
                            currentPart += (currentPart ? ' ' : '') + word;
                        } else {
                            if (currentPart) {
                                parts.push(currentPart + ',');
                                currentPart = word;
                            } else {
                                parts.push(word);
                            }
                        }
                    }

                    if (currentPart) {
                        parts.push(currentPart);
                    }

                    // 最後の部分に句読点を追加
                    if (parts.length > 0) {
                        parts[parts.length - 1] += punctuation;
                    }

                    processedSentences.push(parts.join(' ... '));
                } else {
                    processedSentences.push(sentence + punctuation);
                }
            }

            return processedSentences.join(' ');
        }

        // 日本語テキストの前処理関数
        function preprocessJapaneseText(text) {
            let processed = text;

            // 読みがな機能（例：東京[とうきょう]）
            processed = processed.replace(/([^\[\]]+)\[([^\[\]]+)\]/g, '$2');

            // 句読点の後に間を追加
            processed = processed.replace(/。/g, '。　'); // 全角スペース
            processed = processed.replace(/、/g, '、 '); // 半角スペース
            processed = processed.replace(/！/g, '！　　'); // 長い間
            processed = processed.replace(/？/g, '？　　'); // 長い間

            // 会話文の検出と処理
            processed = processed.replace(/「([^」]+)」/g, (match, content) => {
                return `「 ${content} 」`; // 会話文の前後にスペース
            });

            // 強調記法の処理（**text**）
            processed = processed.replace(/\*\*([^*]+)\*\*/g, (match, content) => {
                return ` ${content} `; // 強調部分の前後にスペース
            });

            // 括弧内の処理
            processed = processed.replace(/（([^）]+)）/g, (match, content) => {
                return ` （${content}） `; // 括弧の前後にスペース
            });

            // 漢字の連続を避けるためのスペース挿入（実験的）
            // 長い漢字列の間に微小な間を追加
            processed = processed.replace(/([一-龯]{4,})/g, (match) => {
                return match.replace(/([一-龯]{2})([一-龯]{2})/g, '$1 $2');
            });

            // 数字の読み方を改善
            processed = processed.replace(/(\d+)年/g, '$1ねん');
            processed = processed.replace(/(\d+)月/g, '$1がつ');
            processed = processed.replace(/(\d+)日/g, '$1にち');
            processed = processed.replace(/(\d+)時/g, '$1じ');
            processed = processed.replace(/(\d+)分/g, '$1ふん');

            // 余分なスペースを整理
            processed = processed.replace(/\s+/g, ' ');
            processed = processed.trim();

            return processed;
        }

        // 高品質音声の判定
        function getVoiceQuality(voice) {
            const highQualityProviders = ['Google', 'Microsoft', 'Apple', 'Amazon'];
            const isHighQuality = highQualityProviders.some(provider =>
                voice.name.includes(provider) || voice.voiceURI.includes(provider)
            );
            return isHighQuality ? '★' : '';
        }

        // 音声リストの読み込み
        function loadVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '<option value="">自動選択</option>';

            // 音声を分類
            const jpVoices = voices.filter(voice => voice.lang.includes('ja'))
                .sort((a, b) => getVoiceQuality(b).length - getVoiceQuality(a).length);
            const enVoices = voices.filter(voice => voice.lang.includes('en'))
                .sort((a, b) => getVoiceQuality(b).length - getVoiceQuality(a).length);
            const otherVoices = voices.filter(voice => !voice.lang.includes('ja') && !voice.lang.includes('en'));

            // 日本語音声を追加
            if (jpVoices.length > 0) {
                const jpGroup = document.createElement('optgroup');
                jpGroup.label = '日本語';
                jpVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)} ${voice.name}`;
                    jpGroup.appendChild(option);
                });
                voiceSelect.appendChild(jpGroup);
            }

            // 英語音声を追加
            if (enVoices.length > 0) {
                const enGroup = document.createElement('optgroup');
                enGroup.label = 'English';
                enVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)} ${voice.name}`;
                    enGroup.appendChild(option);
                });
                voiceSelect.appendChild(enGroup);
            }

            // その他の音声を追加
            if (otherVoices.length > 0) {
                const otherGroup = document.createElement('optgroup');
                otherGroup.label = 'その他';
                otherVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    otherGroup.appendChild(option);
                });
                voiceSelect.appendChild(otherGroup);
            }
        }
        
        // 初回読み込みと更新時の処理
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
        
        // スライダーの更新
        // 速度変更の共通処理関数
        function handleRateChange() {
            rateValue.textContent = rateRange.value;
            updateActivePresetBtn('rate', rateRange.value);

            // デバッグ表示を更新
            updateSpeedDebugInfo();

            // リアルタイム速度変更
            handleRealtimeParamChange();
        }

        // 速度スライダーのイベント（PC + モバイル対応）
        rateRange.addEventListener('input', handleRateChange);

        // スマホ専用イベント
        if (isMobile) {
            rateRange.addEventListener('change', handleRateChange);
            rateRange.addEventListener('touchend', () => {
                // touchend後に少し待ってから処理（値が確定するのを待つ）
                setTimeout(handleRateChange, 50);
            });
        }


        // プリセットボタンの機能
        function updateActivePresetBtn(type, value) {
            const buttons = document.querySelectorAll(`[data-${type}]`);
            buttons.forEach(btn => {
                const btnValue = parseFloat(btn.getAttribute(`data-${type}`));
                if (Math.abs(btnValue - parseFloat(value)) < 0.01) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 速度プリセットボタンのイベントリスナー
        document.querySelectorAll('[data-rate]').forEach(btn => {
            btn.addEventListener('click', () => {
                const rate = btn.getAttribute('data-rate');
                rateRange.value = rate;

                // 共通処理を使用（デバッグ表示も更新される）
                handleRateChange();
            });
        });

        // テキスト入力時の言語検出とリアルタイム変更検知
        textInput.addEventListener('input', () => {
            const text = textInput.value.trim();

            // 読み上げ中にテキストが変更された場合
            if (isPlaying && originalText && text !== originalText) {
                synth.cancel();
                status.textContent = 'テキストが変更されました';
                resetButtons();
                originalText = '';
                allSentences = [];
                currentSentenceIndex = 0;
            }

            // 言語検出
            if (text) {
                const lang = detectLanguage(text);
                const langName = lang === 'ja' ? '日本語' : 'English';
                detectedLanguage.textContent = langName;
                languageInfo.style.display = 'block';
            } else {
                languageInfo.style.display = 'none';
            }
        });
        
        // スマホ専用の英語音声選択機能
        function getMobileOptimalEnglishVoice() {
            let englishVoices = voices.filter(voice =>
                voice.lang.includes('en') || voice.lang.toLowerCase().includes('english')
            );

            // モバイルでない場合は既存のロジックを使用
            if (!isMobile) {
                const highQualityVoices = englishVoices.filter(voice => getVoiceQuality(voice));
                return highQualityVoices.length > 0 ? highQualityVoices[0] : (englishVoices.length > 0 ? englishVoices[0] : null);
            }

            let selectedVoice = null;

            if (isIOS) {
                // iOS専用の音声優先順位
                const iosPriorities = [
                    'Samantha',     // Siri女性音声
                    'Alex',         // 男性音声
                    'Daniel',       // イギリス英語
                    'Karen',        // オーストラリア英語
                    'Moira'         // アイルランド英語
                ];

                // 優先順位に基づいて検索
                for (const priority of iosPriorities) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.toLowerCase().includes(priority.toLowerCase()) ||
                        voice.voiceURI.toLowerCase().includes(priority.toLowerCase())
                    );
                    if (selectedVoice) break;
                }

                // 見つからない場合、com.appleを含む音声を探す
                if (!selectedVoice) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.voiceURI.includes('com.apple') || voice.name.includes('Apple')
                    );
                }
            } else if (isAndroid) {
                // Android専用の音声優先順位
                const androidPriorities = [
                    'Google US English',
                    'Google UK English',
                    'Samsung'
                ];

                // 優先順位に基づいて検索
                for (const priority of androidPriorities) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.includes(priority) || voice.voiceURI.includes(priority)
                    );
                    if (selectedVoice) break;
                }

                // 見つからない場合、Googleまたは名前にEnglishを含む音声を探す
                if (!selectedVoice) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.includes('Google') && voice.name.includes('English')
                    );
                }

                if (!selectedVoice) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.toLowerCase().includes('english')
                    );
                }
            }

            // 音声が見つからない場合の対策
            if (!selectedVoice) {
                // en-USからenに変更して再試行
                englishVoices = voices.filter(voice => voice.lang === 'en');
                selectedVoice = englishVoices.length > 0 ? englishVoices[0] : null;
            }

            // まだ見つからない場合、localServiceがfalseの音声（オンライン音声）を試す
            if (!selectedVoice) {
                const onlineVoices = voices.filter(voice =>
                    (voice.lang.includes('en') || voice.lang.toLowerCase().includes('english')) &&
                    voice.localService === false
                );
                selectedVoice = onlineVoices.length > 0 ? onlineVoices[0] : null;
            }

            // デバッグ情報を更新
            updateVoiceDebugInfo(selectedVoice);

            return selectedVoice || (englishVoices.length > 0 ? englishVoices[0] : null);
        }

        // 音声選択のデバッグ情報を更新
        function updateVoiceDebugInfo(voice) {
            const debugInfo = document.getElementById('voiceDebugInfo');
            const voiceName = document.getElementById('selectedVoiceName');

            if (voice && debugInfo && voiceName) {
                let deviceInfo = '';
                if (isIOS) deviceInfo = 'iOS';
                else if (isAndroid) deviceInfo = 'Android';
                else if (isMobile) deviceInfo = 'Mobile';
                else deviceInfo = 'PC';

                voiceName.textContent = `${voice.name} (${deviceInfo})`;
                debugInfo.style.display = 'block';

                // 速度とピッチの情報も更新
                updateSpeedDebugInfo();
            }
        }

        // 速度・ピッチのデバッグ情報を更新
        function updateSpeedDebugInfo() {
            const speedDebug = document.getElementById('currentSpeedDebug');
            const pitchDebug = document.getElementById('currentPitchDebug');
            const debugInfo = document.getElementById('voiceDebugInfo');

            if (speedDebug && pitchDebug) {
                const currentRate = rateRange.value;
                const currentPitch = pitchRange.value;

                // スマホの場合は実際に適用される値も表示
                if (isMobile) {
                    const detectedLang = detectLanguage(textInput.value.trim());
                    const actualParams = getMobileOptimizedParams(detectedLang, currentRate, currentPitch);
                    speedDebug.textContent = `${currentRate} → ${actualParams.rate.toFixed(2)}`;
                    pitchDebug.textContent = `${currentPitch} → ${actualParams.pitch.toFixed(2)}`;
                } else {
                    speedDebug.textContent = currentRate;
                    pitchDebug.textContent = currentPitch;
                }

                // デバッグ情報を表示
                if (debugInfo) {
                    debugInfo.style.display = 'block';
                }
            }
        }

        // 読み上げパラメータを取得（ピッチは固定1.0）
        function getMobileOptimizedParams(detectedLang, baseRate) {
            if (!isMobile) {
                // PCの場合は既存のロジック
                if (detectedLang === 'en') {
                    return {
                        rate: parseFloat(baseRate) * 0.9,
                        pitch: 1.0,
                        volume: 1.0
                    };
                } else {
                    return {
                        rate: parseFloat(baseRate),
                        pitch: 1.0,
                        volume: 1.0
                    };
                }
            }

            // スマホ専用の設定
            if (detectedLang === 'en') {
                return {
                    rate: parseFloat(baseRate) * 0.95, // スマホの英語はユーザー設定値の95%（少し自然に）
                    pitch: 1.0,      // ピッチは固定
                    volume: 1.0
                };
            } else {
                // 日本語などの他の言語
                return {
                    rate: parseFloat(baseRate),
                    pitch: 1.0,
                    volume: 1.0
                };
            }
        }

        // 最適な音声を自動選択
        function getOptimalVoice(detectedLang) {
            let targetVoices;
            if (detectedLang === 'ja') {
                targetVoices = voices.filter(voice => voice.lang.includes('ja'));

                // 日本語音声の優先順位
                const priorityOrder = [
                    'Google', // 最も自然
                    'Microsoft Nanami',
                    'Microsoft Haruka',
                    'Apple Kyoko',
                    'Apple Otoya'
                ];

                // 優先順位に基づいて音声を選択
                for (const priority of priorityOrder) {
                    const preferredVoice = targetVoices.find(voice =>
                        voice.name.includes(priority) || voice.voiceURI.includes(priority)
                    );
                    if (preferredVoice) {
                        return preferredVoice;
                    }
                }
            } else if (detectedLang === 'en') {
                return getMobileOptimalEnglishVoice();
            } else {
                targetVoices = voices.filter(voice => voice.lang.includes('en'));

                // 高品質音声を優先
                const highQualityVoices = targetVoices.filter(voice => getVoiceQuality(voice));
                if (highQualityVoices.length > 0) {
                    return highQualityVoices[0];
                }
            }

            return targetVoices.length > 0 ? targetVoices[0] : null;
        }

        // 日本語読み上げパラメータの最適化
        function getOptimizedJapaneseParams(text, baseRate, basePitch) {
            const textLength = text.length;
            let optimizedRate = baseRate;
            let optimizedPitch = basePitch;

            // 文章の長さに応じてrateを調整
            if (textLength < 30) {
                optimizedRate = Math.min(baseRate * 1.05, 0.9); // 短文は少し速め
            } else if (textLength > 100) {
                optimizedRate = Math.max(baseRate * 0.95, 0.85); // 長文は少し遅め
            } else {
                optimizedRate = Math.max(baseRate * 0.95, 0.85); // 中文は遅め
            }

            // イントネーション改善
            if (text.includes('？') || text.includes('ですか') || text.includes('ますか')) {
                // 疑問文の場合、ピッチを少し上げる
                optimizedPitch = Math.min(basePitch * 1.05, 1.1);
            } else if (text.includes('！') || text.includes('です！') || text.includes('ます！')) {
                // 感嘆文の場合、ピッチを高く、スピードを少し速く
                optimizedPitch = Math.min(basePitch * 1.1, 1.15);
                optimizedRate = Math.min(optimizedRate * 1.05, 0.95);
            } else {
                // 通常の文は自然な抑揚
                optimizedPitch = Math.max(Math.min(basePitch, 1.05), 0.95);
            }

            return { rate: optimizedRate, pitch: optimizedPitch };
        }

        // 読み上げ/一時停止機能
        playPauseBtn.addEventListener('click', () => {
            // 一時停止中の場合は再開
            if (isPaused) {
                synth.resume();
                isPaused = false;
                updatePlayPauseButton(true);
                status.textContent = '読み上げ中...';
                return;
            }

            // 再生中の場合は一時停止
            if (isPlaying && synth.speaking) {
                synth.pause();
                isPaused = true;
                updatePlayPauseButton(false);
                status.textContent = '一時停止中...';
                return;
            }
            const text = textInput.value.trim();

            if (!text) {
                status.textContent = 'テキストを入力してください';
                return;
            }

            // 既存の読み上げを停止
            synth.cancel();
            isPaused = false;
            currentPosition = 0;

            // 言語検出
            const detectedLang = detectLanguage(text);

            // テキストの前処理
            let processedText = text;
            if (detectedLang === 'en') {
                processedText = preprocessEnglishText(text);
            } else if (detectedLang === 'ja') {
                processedText = preprocessJapaneseText(text);
            }

            currentText = processedText;
            originalText = text; // リアルタイム変更検知用

            // 日本語の場合は文章分割して自然な間を作る
            if (detectedLang === 'ja') {
                speakJapaneseWithPauses(processedText);
                return;
            }

            // 英語その他の言語の従来処理
            const utterance = new SpeechSynthesisUtterance(processedText);
            currentUtterance = utterance;

            // 音声の選択
            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== '' && voices[selectedIndex]) {
                utterance.voice = voices[selectedIndex];
            } else {
                // 自動選択
                const optimalVoice = getOptimalVoice(detectedLang);
                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                }
            }

            // 言語別パラメータの最適化（モバイル対応）
            const optimizedParams = getMobileOptimizedParams(detectedLang, rateRange.value);
            utterance.rate = optimizedParams.rate;
            utterance.pitch = 1.0;
            utterance.volume = optimizedParams.volume;

        // 日本語文章分割読み上げ機能
        function speakJapaneseWithPauses(text) {
            // 文章を句点と段落で分割
            allSentences = text.split(/([。！？]|\n\n+)/).filter(s => s.trim());
            currentSentenceIndex = 0;
            originalText = text;

            // 履歴に保存
            saveToHistory(text, 'ja', rateRange.value);

            speakJapaneseFromIndex(0);
        }

        function speakJapaneseFromIndex(startIndex) {
            currentSentenceIndex = startIndex;

            function speakNextSentence() {
                if (currentSentenceIndex >= allSentences.length) {
                    status.textContent = '読み上げ完了';
                    resetButtons();
                    return;
                }

                const sentence = allSentences[currentSentenceIndex].trim();
                currentSentenceIndex++;

                // 空の文や区切り文字のみの場合はスキップ
                if (!sentence || /^[。！？\s]*$/.test(sentence)) {
                    // 段落切り替えの場合は500ms待機
                    if (sentence.includes('\n')) {
                        setTimeout(speakNextSentence, 500);
                    } else {
                        speakNextSentence();
                    }
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(sentence);
                currentUtterance = utterance;

                // 音声選択
                const selectedIndex = voiceSelect.value;
                if (selectedIndex !== '' && voices[selectedIndex]) {
                    utterance.voice = voices[selectedIndex];
                } else {
                    const optimalVoice = getOptimalVoice('ja');
                    if (optimalVoice) {
                        utterance.voice = optimalVoice;
                    }
                }

                // 日本語最適化パラメータを適用
                const baseRate = parseFloat(rateRange.value);
                const basePitch = parseFloat(pitchRange.value);
                const optimized = getOptimizedJapaneseParams(sentence, baseRate, basePitch);

                utterance.rate = optimized.rate;
                utterance.pitch = optimized.pitch;
                utterance.volume = 1.0;

                // イベントハンドラ
                utterance.onstart = () => {
                    if (currentSentenceIndex === 1) {
                        status.textContent = '読み上げ中...';
                        updatePlayPauseButton(true);
                        playPauseBtn.disabled = false;
                        skipBackBtn.disabled = false;
                        skipForwardBtn.disabled = false;
                    }
                };

                utterance.onend = () => {
                    // 文と文の間に300ms、段落の間に500msの自然な間を追加
                    const nextSentence = allSentences[currentSentenceIndex];
                    const pauseDuration = (nextSentence && nextSentence.includes('\n')) ? 500 : 300;

                    setTimeout(speakNextSentence, pauseDuration);
                };

                utterance.onerror = () => {
                    status.textContent = 'エラーが発生しました';
                    resetButtons();
                };

                synth.speak(utterance);
            }

            speakNextSentence();
        }

            // イベントハンドラ
            utterance.onstart = () => {
                status.textContent = '読み上げ中...';
                updatePlayPauseButton(true);
                playPauseBtn.disabled = false;
                skipBackBtn.disabled = false;
                skipForwardBtn.disabled = false;
            };

            utterance.onend = () => {
                status.textContent = '読み上げ完了';
                resetButtons();
            };

            utterance.onerror = () => {
                status.textContent = 'エラーが発生しました';
                resetButtons();
            };

            // 履歴に保存
            saveToHistory(text, detectedLang, rateRange.value);

            // 読み上げ開始
            synth.speak(utterance);
        });
        

        // 停止機能
        stopBtn.addEventListener('click', () => {
            synth.cancel();
            status.textContent = '停止しました';
            resetButtons();
        });
        
        // 初期状態の設定
        skipBackBtn.disabled = true;
        skipForwardBtn.disabled = true;

        // スキップ機能
        function skipText(seconds, direction) {
            if (!currentText) return;

            const words = currentText.split(/\s+/);
            const wordsPerSecond = 2.5; // 平均的な読み上げ速度
            const skipWords = Math.floor(seconds * wordsPerSecond);

            if (direction === 'forward') {
                currentPosition = Math.min(currentPosition + skipWords, words.length);
            } else {
                currentPosition = Math.max(currentPosition - skipWords, 0);
            }

            if (synth.speaking) {
                synth.cancel();
                const remainingText = words.slice(currentPosition).join(' ');
                if (remainingText) {
                    speakFromPosition(remainingText);
                } else {
                    status.textContent = '読み上げ完了';
                    resetButtons();
                }
            }
        }

        function speakFromPosition(text) {
            if (!text.trim()) return;

            const utterance = new SpeechSynthesisUtterance(text);
            currentUtterance = utterance;

            // 音声設定を適用
            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== '' && voices[selectedIndex]) {
                utterance.voice = voices[selectedIndex];
            } else {
                const detectedLang = detectLanguage(text);
                const optimalVoice = getOptimalVoice(detectedLang);
                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                }
            }

            const detectedLang = detectLanguage(text);
            if (detectedLang === 'en') {
                utterance.rate = parseFloat(rateRange.value) * 0.9;
                utterance.pitch = 1.0;
            } else {
                utterance.rate = parseFloat(rateRange.value);
                utterance.pitch = 1.0;
            }

            utterance.onstart = () => {
                status.textContent = '読み上げ中...';
                updatePlayPauseButton(true);
                playPauseBtn.disabled = false;
                skipBackBtn.disabled = false;
                skipForwardBtn.disabled = false;
            };

            utterance.onend = () => {
                status.textContent = '読み上げ完了';
                resetButtons();
            };

            utterance.onerror = () => {
                status.textContent = 'エラーが発生しました';
                resetButtons();
            };

            synth.speak(utterance);
        }

        function resetButtons() {
            updatePlayPauseButton(false);
            playPauseBtn.disabled = false;
            skipBackBtn.disabled = true;
            skipForwardBtn.disabled = true;
            currentUtterance = null;
            isPaused = false;
            currentPosition = 0;

            // リアルタイム変更用変数もリセット
            isRealTimeChanging = false;
        }

        // スキップボタンのイベントリスナー
        skipBackBtn.addEventListener('click', () => {
            skipText(15, 'backward');
        });

        skipForwardBtn.addEventListener('click', () => {
            skipText(15, 'forward');
        });

        // ブラウザ対応チェック
        if (!('speechSynthesis' in window)) {
            alert('お使いのブラウザは音声合成に対応していません');
            playPauseBtn.disabled = true;
        }

        // 例文ボタンの機能
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-text');

                // テキストエリアに例文を入力
                textInput.value = text;

                // クリックアニメーション
                btn.classList.add('clicked');
                setTimeout(() => {
                    btn.classList.remove('clicked');
                }, 200);

                // 言語検出をトリガー
                const event = new Event('input', { bubbles: true });
                textInput.dispatchEvent(event);

                // テキストエリアにスクロール
                textInput.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // 少し待ってからフォーカス
                setTimeout(() => {
                    textInput.focus();
                }, 300);
            });
        });

        // 初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            // 初期のデバッグ表示を更新
            updateSpeedDebugInfo();

            // モバイルデバイスの場合、デバッグ情報を表示
            if (isMobile) {
                const debugInfo = document.getElementById('voiceDebugInfo');
                if (debugInfo) {
                    debugInfo.style.display = 'block';
                }
            }

            // 履歴関連のイベントリスナー
            const historyBtn = document.getElementById('historyBtn');
            const closeHistoryBtn = document.getElementById('closeHistoryModal');
            const historyModal = document.getElementById('historyModal');
            const clearAllBtn = document.getElementById('clearAllHistoryBtn');

            if (historyBtn) {
                historyBtn.addEventListener('click', openHistoryModal);
            }

            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener('click', closeHistoryModal);
            }

            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', () => {
                    if (confirm('すべての履歴を削除しますか？この操作は取り消せません。')) {
                        clearHistory();
                        displayHistory();
                    }
                });
            }

            // モーダル外クリックで閉じる
            if (historyModal) {
                historyModal.addEventListener('click', (e) => {
                    if (e.target === historyModal) {
                        closeHistoryModal();
                    }
                });
            }

            // ESCキーでモーダルを閉じる
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && historyModal.style.display === 'flex') {
                    closeHistoryModal();
                }
            });
        });

        // Service Worker登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker登録成功:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker登録失敗:', error);
                    });
            });
        }
    </script>
</body>
</html>
