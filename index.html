<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maru-Text-to-Speech</title>
    <meta name="description" content="„Ç∑„É≥„Éó„É´„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ„ÉÜ„Ç≠„Çπ„ÉàË™≠„Åø‰∏ä„Åí„ÉÑ„Éº„É´">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <meta name="theme-color" content="#3B82F6">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f2937;
        }

        .container {
            background: #ffffff;
            border-radius: 6px;
            padding: 32px;
            max-width: 640px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        h1 {
            color: #1f2937;
            margin-bottom: 32px;
            text-align: center;
            font-weight: 600;
            font-size: 28px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 24px;
            background: #ffffff;
            color: #1f2937;
            font-family: inherit;
        }

        /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ÊúÄÈÅ©Âåñ */
        @media (max-width: 768px) {
            textarea {
                min-height: 120px;
                padding: 16px;
                font-size: 16px; /* iOS Safari„Åß„Ç∫„Éº„É†„ÇíÈò≤„Åê„Åü„ÇÅ */
                border-radius: 8px;
                margin-bottom: 20px;
            }
        }

        textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        textarea::placeholder {
            color: #9ca3af;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 24px;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #ffffff;
            color: #1f2937;
            font-size: 16px;
        }

        select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: center;
            margin: 32px 0;
        }

        button {
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-out;
            font-weight: 500;
        }

        .btn-play-pause {
            background: #2563eb;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.15);
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }

        .btn-play-pause.playing {
            background: #f59e0b;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.15);
        }

        .btn-play-pause:hover:not(:disabled) {
            background: #3b82f6;
        }

        .btn-play-pause.playing:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-play-pause:active:not(:disabled) {
            background: #1d4ed8;
        }

        .btn-play-pause.playing:active:not(:disabled) {
            background: #b45309;
        }

        .btn-play-pause:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .btn-icon {
            transition: opacity 0.2s ease-out;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .btn-icon.hidden {
            opacity: 0;
        }

        .btn-stop {
            background: #ffffff;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-stop:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .btn-stop:disabled {
            opacity: 0.5;
            cursor: default;
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status {
            text-align: center;
            margin-top: 24px;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .language-info {
            background: #f9fafb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            border-left: 3px solid #2563eb;
        }

        .language-info span {
            font-weight: 500;
            color: #1f2937;
            font-size: 14px;
        }

        .voice-quality {
            color: #ffd700;
        }

        .pitch-control {
            width: 100%;
            margin-top: 10px;
        }

        .btn-pause {
            background: #ffffff;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-pause:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .flag-icon {
            margin-left: 8px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 0 12px;
            height: 32px;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            background: #ffffff;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-out;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ÊúÄÈÅ©Âåñ */
        @media (max-width: 768px) {
            .preset-btn {
                padding: 0 16px;
                height: 40px;
                min-height: 40px;
                font-size: 14px;
                min-width: 48px;
            }
        }

        .preset-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .preset-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 8px;
            display: block;
            font-size: 13px;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            margin: 8px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #2563eb;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #2563eb;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .slider-value {
            background: #2563eb;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            min-width: 36px;
            text-align: center;
        }

        .skip-btn {
            width: 48px;
            height: 40px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            position: relative;
        }

        .skip-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .skip-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .skip-btn svg {
            width: 18px;
            height: 18px;
            stroke: #374151;
            stroke-width: 3px;
            fill: #374151;
        }

        .skip-text {
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            margin-top: 2px;
            line-height: 1;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            background: #f9fafb;
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            .buttons {
                margin: 24px 0;
            }

            .control-buttons {
                gap: 12px;
                padding: 16px 20px;
            }

            .btn-play-pause {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }

            .skip-btn {
                width: 52px;
                height: 44px;
                min-height: 44px;
            }

            .skip-btn svg {
                width: 18px;
                height: 18px;
            }

            .skip-text {
                font-size: 11px;
                margin-top: 2px;
            }

            .btn-stop {
                width: 44px;
                height: 44px;
                min-height: 44px;
            }

            .btn-stop svg {
                width: 16px;
                height: 16px;
            }
        }

        .examples-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-top: 32px;
            border: 1px solid #e5e7eb;
        }

        .examples-section h3 {
            color: #1f2937;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .examples-description {
            color: #6b7280;
            font-size: 13px;
            text-align: center;
            margin-bottom: 24px;
        }

        .examples-category {
            margin-bottom: 24px;
        }

        .examples-category:last-child {
            margin-bottom: 0;
        }

        .examples-category h4 {
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .example-group {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }

        .example-group h5 {
            color: #374151;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .example-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px 0;
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .example-btn:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
        }

        .example-btn:active {
            background: #dbeafe;
        }

        .example-btn.clicked {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        @media (max-width: 640px) {
            .examples-grid {
                grid-template-columns: 1fr;
            }

            .examples-section {
                padding: 20px;
                margin-top: 24px;
            }
        }

        /* Â±•Ê≠¥Ê©üËÉΩ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„Éò„ÉÉ„ÉÄ„ÉºÊúÄÈÅ©Âåñ */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                padding: 1rem 0.75rem;
                margin-bottom: 1.5rem;
            }

            .header h1 {
                margin: 0 0 0.75rem 0;
                font-size: 1.5rem;
                line-height: 1.2;
            }
        }

        .history-btn {
            padding: 0.75rem 1.25rem;
            background: #3B82F6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            min-height: 44px;
            min-width: 80px;
            justify-content: center;
        }

        /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„Éú„Çø„É≥ÊúÄÈÅ©Âåñ */
        @media (max-width: 768px) {
            .history-btn {
                padding: 0.875rem 1.5rem;
                font-size: 1rem;
                min-height: 48px;
                min-width: 120px;
            }
        }

        .history-btn:hover {
            background: #2563EB;
            transform: translateY(-1px);
        }

        .history-btn:active {
            transform: translateY(0);
        }

        /* Â±•Ê≠¥„É¢„Éº„ÉÄ„É´ */
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .history-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .history-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .history-modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .history-item-text {
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .history-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .practice-btn, .delete-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .practice-btn {
            background: #3B82F6;
            color: white;
        }

        .practice-btn:hover {
            background: #2563EB;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .clear-all-btn {
            width: 100%;
            padding: 0.75rem;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        .clear-all-btn:hover {
            background: #4b5563;
        }

        .history-empty {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .history-empty-sub {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-item-lang {
            font-size: 0.8rem;
            font-weight: bold;
            color: #3B82F6;
        }

        .history-item-date {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .history-item-params {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0.5rem 0;
        }

        .history-practice-btn, .history-delete-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-practice-btn {
            background: #3B82F6;
            color: white;
        }

        .history-practice-btn:hover {
            background: #2563EB;
        }

        .history-delete-btn {
            background: #ef4444;
            color: white;
        }

        .history-delete-btn:hover {
            background: #dc2626;
        }

        .empty-history {
            text-align: center;
            color: #6b7280;
            padding: 3rem 1rem;
        }

        .empty-history-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-history-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-history-subtext {
            font-size: 0.9rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Maru-Text-to-Speech</h1>
            <button id="historyBtn" class="history-btn">
                üìö Â±•Ê≠¥
            </button>
        </div>
        
        <textarea id="textInput" placeholder="Ë™≠„Åø‰∏ä„Åí„Åü„ÅÑ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>

        <div id="languageInfo" class="language-info" style="display: none;">
            <span>Ê§úÂá∫Ë®ÄË™û:</span> <span id="detectedLanguage"></span>
        </div>

        <div class="controls">
            <select id="voiceSelect">
                <option value="">Èü≥Â£∞„ÇíÈÅ∏Êäû...</option>
            </select>

            <div class="control-group">
                <label class="control-label">ÈÄüÂ∫¶: <span id="rateValue">1.0</span>x</label>
                <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1">
                <div class="preset-buttons">
                    <button class="preset-btn" data-rate="0.75">0.75x</button>
                    <button class="preset-btn active" data-rate="1.0">1.0x</button>
                    <button class="preset-btn" data-rate="1.25">1.25x</button>
                    <button class="preset-btn" data-rate="1.5">1.5x</button>
                    <button class="preset-btn" data-rate="1.75">1.75x</button>
                    <button class="preset-btn" data-rate="2.0">2.0x</button>
                </div>
            </div>

        </div>
        
        <div class="buttons">
            <div class="control-buttons">
                <button id="skipBackBtn" class="skip-btn" title="15ÁßíÊàª„Çã">
                    <svg viewBox="0 0 24 24">
                        <path d="M11 17l-5-5 5-5v10z" fill="#374151"/>
                        <path d="M18 17l-5-5 5-5v10z" fill="#374151"/>
                    </svg>
                    <span class="skip-text">15</span>
                </button>
                <button id="playPauseBtn" class="btn-play-pause">
                    <svg class="btn-icon play-icon" viewBox="0 0 24 24" fill="white">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="btn-icon pause-icon hidden" viewBox="0 0 24 24" fill="white">
                        <path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"/>
                    </svg>
                </button>
                <button id="skipForwardBtn" class="skip-btn" title="15ÁßíÈÄ≤„ÇÄ">
                    <svg viewBox="0 0 24 24">
                        <path d="M13 7l5 5-5 5V7z" fill="#374151"/>
                        <path d="M6 7l5 5-5 5V7z" fill="#374151"/>
                    </svg>
                    <span class="skip-text">15</span>
                </button>
                <button id="stopBtn" class="btn-stop" title="ÂÅúÊ≠¢">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="status" class="status">Ê∫ñÂÇôÂÆå‰∫Ü</div>

        <!-- „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫ÔºàÈü≥Â£∞ÊÉÖÂ†±Ôºâ -->
        <div id="voiceDebugInfo" class="voice-debug-info" style="display: none;">
            <small style="color: #666; font-size: 12px;">
                üé§ Èü≥Â£∞: <span id="selectedVoiceName">Êú™ÈÅ∏Êäû</span><br>
                ‚ö° ÈÄüÂ∫¶: <span id="currentSpeedDebug">1.0</span>
            </small>
        </div>

        <div class="examples-section">
            <h3>Ë©¶„Åó„Å¶„Åø„Çà„ÅÜ - Example Phrases</h3>
            <p class="examples-description">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰æãÊñá„ÇíË©¶„Åô - Click to try example phrases</p>

            <div class="examples-category">
                <h4>üá∫üá∏ English</h4>
                <div class="examples-grid">
                    <div class="example-group">
                        <h5>Greetings & Introduction</h5>
                        <button class="example-btn" data-text="Hello! My name is Sarah. Nice to meet you.">Hello! My name is Sarah. Nice to meet you.</button>
                        <button class="example-btn" data-text="How are you doing today? I hope you're having a great day!">How are you doing today? I hope you're having a great day!</button>
                    </div>

                    <div class="example-group">
                        <h5>Daily Conversation</h5>
                        <button class="example-btn" data-text="Could you tell me where the nearest station is?">Could you tell me where the nearest station is?</button>
                        <button class="example-btn" data-text="I'd like to have a coffee, please. Do you have any recommendations?">I'd like to have a coffee, please. Do you have any recommendations?</button>
                        <button class="example-btn" data-text="The weather is beautiful today, isn't it?">The weather is beautiful today, isn't it?</button>
                    </div>

                    <div class="example-group">
                        <h5>Business</h5>
                        <button class="example-btn" data-text="Thank you for your email. I'll get back to you by tomorrow.">Thank you for your email. I'll get back to you by tomorrow.</button>
                        <button class="example-btn" data-text="Let's schedule a meeting for next week. When are you available?">Let's schedule a meeting for next week. When are you available?</button>
                    </div>
                </div>
            </div>

            <div class="examples-category">
                <h4>üáØüáµ Êó•Êú¨Ë™û</h4>
                <div class="examples-grid">
                    <div class="example-group">
                        <h5>„Éì„Ç∏„Éç„Çπ</h5>
                        <button class="example-btn" data-text="„Åì„Çì„Å´„Å°„ÅØ„ÄÇÊú¨Êó•„ÅØ„ÅäÊôÇÈñì„Çí„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ">„Åì„Çì„Å´„Å°„ÅØ„ÄÇÊú¨Êó•„ÅØ„ÅäÊôÇÈñì„Çí„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ</button>
                        <button class="example-btn" data-text="ÊòéÊó•„ÅÆ‰ºöË≠∞„ÅÆË≥áÊñô„ÇíÈÄÅ„Çâ„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ">ÊòéÊó•„ÅÆ‰ºöË≠∞„ÅÆË≥áÊñô„ÇíÈÄÅ„Çâ„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
        <div id="historyModal" class="history-modal">
            <div class="history-modal-content">
                <div class="history-modal-header">
                    <h2 class="history-modal-title">üìö Ë™≠„Åø‰∏ä„ÅíÂ±•Ê≠¥</h2>
                    <button id="closeHistoryModal" class="close-btn">&times;</button>
                </div>
                <div class="history-modal-body">
                    <div id="historyList"></div>
                    <button id="clearAllHistoryBtn" class="clear-all-btn" style="display: none;">
                        üóëÔ∏è „Åô„Åπ„Å¶ÂâäÈô§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Èü≥Â£∞ÂêàÊàê„ÅÆÂàùÊúüÂåñ
        const synth = window.speechSynthesis;
        let voices = [];
        let currentUtterance = null;
        let isPaused = false;
        let currentText = '';
        let currentPosition = 0;
        let isPlaying = false;

        // „É™„Ç¢„É´„Çø„Ç§„É†Â§âÊõ¥Áî®„ÅÆÂ§âÊï∞
        let originalText = ''; // ÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÔºàÂ§âÊõ¥Ê§úÁü•Áî®Ôºâ
        let currentSentenceIndex = 0; // ÁèæÂú®„ÅÆÊñáÁ´†„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàÊó•Êú¨Ë™ûÂàÜÂâ≤Áî®Ôºâ
        let allSentences = []; // ÂàÜÂâ≤„Åï„Çå„ÅüÂÖ®ÊñáÁ´†ÔºàÊó•Êú¨Ë™ûÁî®Ôºâ
        let isRealTimeChanging = false; // „É™„Ç¢„É´„Çø„Ç§„É†Â§âÊõ¥‰∏≠„Éï„É©„Ç∞

        // „Éá„Éê„Ç§„ÇπÂà§ÂÆöÊ©üËÉΩ
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);

        // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫Áî®„ÅÆË¶ÅÁ¥†„ÇíËøΩÂä†
        let selectedVoiceInfo = null;

        // Â±•Ê≠¥ÁÆ°ÁêÜÊ©üËÉΩ
        function saveToHistory(text, language, rate) {
            try {
                const history = JSON.parse(localStorage.getItem('ttsHistory') || '[]');
                const entry = {
                    text: text,
                    language: language,
                    rate: rate,
                    timestamp: new Date().toISOString()
                };

                // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºàÂêå„Åò„ÉÜ„Ç≠„Çπ„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂâäÈô§„Åó„Å¶„Åã„ÇâËøΩÂä†Ôºâ
                const filteredHistory = history.filter(item => item.text !== text);
                filteredHistory.unshift(entry);

                // ÊúÄÂ§ß50‰ª∂„Åæ„Åß‰øùÂ≠ò
                if (filteredHistory.length > 50) {
                    filteredHistory.splice(50);
                }

                localStorage.setItem('ttsHistory', JSON.stringify(filteredHistory));
                console.log('Â±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', entry);
            } catch (error) {
                console.error('Â±•Ê≠¥‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('ttsHistory') || '[]');
            } catch (error) {
                console.error('Â±•Ê≠¥ÂèñÂæó„Ç®„É©„Éº:', error);
                return [];
            }
        }

        function clearHistory() {
            try {
                localStorage.removeItem('ttsHistory');
                console.log('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Â±•Ê≠¥„ÇØ„É™„Ç¢„Ç®„É©„Éº:', error);
            }
        }

        function deleteHistoryItem(index) {
            try {
                const history = getHistory();
                history.splice(index, 1);
                localStorage.setItem('ttsHistory', JSON.stringify(history));
                console.log('Â±•Ê≠¥È†ÖÁõÆ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                displayHistory(); // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞
            } catch (error) {
                console.error('Â±•Ê≠¥ÂâäÈô§„Ç®„É©„Éº:', error);
            }
        }

        function displayHistory() {
            const historyList = document.getElementById('historyList');
            const clearAllBtn = document.getElementById('clearAllHistoryBtn');
            const history = getHistory();

            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="history-empty">
                        <p>üìù „Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        <p class="history-empty-sub">„ÉÜ„Ç≠„Çπ„Éà„ÇíË™≠„Åø‰∏ä„Åí„Çã„Å®Â±•Ê≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    </div>
                `;
                if (clearAllBtn) clearAllBtn.style.display = 'none';
                return;
            }

            // Â±•Ê≠¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÇØ„É™„Ç¢„Éú„Çø„É≥„ÇíË°®Á§∫
            if (clearAllBtn) clearAllBtn.style.display = 'block';

            historyList.innerHTML = history.map((item, index) => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const languageFlag = item.language === 'ja' ? 'üáØüáµ' : 'üá∫üá∏';
                const truncatedText = item.text.length > 80 ? item.text.substring(0, 80) + '...' : item.text;

                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-item-lang">${languageFlag} ${item.language.toUpperCase()}</span>
                            <span class="history-item-date">${dateStr}</span>
                        </div>
                        <div class="history-item-text">${truncatedText}</div>
                        <div class="history-item-params">
                            ‚ö° ÈÄüÂ∫¶: ${item.rate}
                        </div>
                        <div class="history-item-actions">
                            <button class="history-practice-btn" onclick="practiceHistoryItem(${index})">
                                üéØ Á∑¥Áøí„Åô„Çã
                            </button>
                            <button class="history-delete-btn" onclick="deleteHistoryItem(${index})">
                                üóëÔ∏è ÂâäÈô§
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function practiceHistoryItem(index) {
            try {
                const history = getHistory();
                if (index >= 0 && index < history.length) {
                    const item = history[index];

                    // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´Âæ©ÂÖÉ
                    textInput.value = item.text;

                    // „Éë„É©„É°„Éº„Çø„ÇíÂæ©ÂÖÉ
                    rateRange.value = item.rate;
                    rateValue.textContent = item.rate;

                    // Ë®ÄË™ûÊ§úÂá∫„Çí„Éà„É™„Ç¨„Éº
                    const event = new Event('input', { bubbles: true });
                    textInput.dispatchEvent(event);

                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeHistoryModal();

                    // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
                    setTimeout(() => {
                        textInput.focus();
                        textInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);

                    console.log('Â±•Ê≠¥È†ÖÁõÆ„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü:', item);
                }
            } catch (error) {
                console.error('Â±•Ê≠¥Âæ©ÂÖÉ„Ç®„É©„Éº:', error);
            }
        }

        function openHistoryModal() {
            displayHistory();
            document.getElementById('historyModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // „Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
            document.body.style.overflow = ''; // „Çπ„ÇØ„É≠„Éº„É´Âæ©ÂÖÉ
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†Â§âÊõ¥Áî®„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function handleRealtimeParamChange() {
            if (!isPlaying || isPaused || isRealTimeChanging) return;

            isRealTimeChanging = true;

            // „Çπ„É†„Éº„Ç∫„Å™Âàá„ÇäÊõø„Åà„ÅÆ„Åü„ÇÅ„ÄÅÊúÄÂ∞èÈôê„ÅÆË°®Á§∫Êõ¥Êñ∞
            const originalStatus = status.textContent;
            status.textContent = 'Êõ¥Êñ∞‰∏≠...';

            // ÁèæÂú®„ÅÆË™≠„Åø‰∏ä„Åí„ÇíÂÅúÊ≠¢
            synth.cancel();

            // 50msÂæå„Å´Êñ∞„Åó„ÅÑ„Éë„É©„É°„Éº„Çø„ÅßÂÜçÈñãÔºà„Çπ„É†„Éº„Ç∫„Å™Âàá„ÇäÊõø„ÅàÔºâ
            setTimeout(() => {
                if (allSentences.length > 0 && currentSentenceIndex < allSentences.length) {
                    // Êó•Êú¨Ë™û„ÅÆÂ†¥ÂêàÔºöÁèæÂú®„ÅÆÊñáÁ´†„Åã„ÇâÂÜçÈñã
                    continueJapaneseSpeech();
                } else {
                    // Ëã±Ë™û„Åù„ÅÆ‰ªñ„ÅÆÂ†¥ÂêàÔºöÊúÄÂàù„Åã„ÇâÂÜçÈñã
                    continueNormalSpeech();
                }

                // Âàá„ÇäÊõø„ÅàÂÆå‰∫ÜÂæå„ÄÅÈÅ©Âàá„Å™„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Êàª„Åô
                setTimeout(() => {
                    if (isPlaying) {
                        status.textContent = 'Ë™≠„Åø‰∏ä„Åí‰∏≠...';
                    }
                    isRealTimeChanging = false;
                }, 100);
            }, 50);
        }

        function continueJapaneseSpeech() {
            const detectedLang = detectLanguage(originalText);
            if (detectedLang === 'ja') {
                speakJapaneseFromIndex(currentSentenceIndex);
            }
        }

        function continueNormalSpeech() {
            const text = textInput.value.trim();
            if (!text) return;

            const detectedLang = detectLanguage(text);
            let processedText = text;

            if (detectedLang === 'en') {
                processedText = preprocessEnglishText(text);
            } else if (detectedLang === 'ja') {
                processedText = preprocessJapaneseText(text);
            }

            const utterance = new SpeechSynthesisUtterance(processedText);
            currentUtterance = utterance;

            // Èü≥Â£∞ÈÅ∏Êäû
            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== '' && voices[selectedIndex]) {
                utterance.voice = voices[selectedIndex];
            } else {
                const optimalVoice = getOptimalVoice(detectedLang);
                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                }
            }

            // „Éë„É©„É°„Éº„ÇøË®≠ÂÆöÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
            const optimizedParams = getMobileOptimizedParams(detectedLang, rateRange.value);
            utterance.rate = optimizedParams.rate;
            utterance.pitch = 1.0;
            utterance.volume = optimizedParams.volume;

            utterance.onstart = () => {
                status.textContent = 'Ë™≠„Åø‰∏ä„Åí‰∏≠...';
            };

            utterance.onend = () => {
                status.textContent = 'Ë™≠„Åø‰∏ä„ÅíÂÆå‰∫Ü';
                resetButtons();
            };

            utterance.onerror = () => {
                status.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                resetButtons();
            };

            synth.speak(utterance);
        }

        // „Éú„Çø„É≥„Ç¢„Ç§„Ç≥„É≥Âàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function updatePlayPauseButton(playing) {
            if (playing) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                playPauseBtn.classList.add('playing');
                isPlaying = true;
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playPauseBtn.classList.remove('playing');
                isPlaying = false;
            }
        }

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateRange = document.getElementById('rateRange');
        const rateValue = document.getElementById('rateValue');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.querySelector('.play-icon');
        const pauseIcon = document.querySelector('.pause-icon');
        const stopBtn = document.getElementById('stopBtn');
        const skipBackBtn = document.getElementById('skipBackBtn');
        const skipForwardBtn = document.getElementById('skipForwardBtn');
        const status = document.getElementById('status');
        const languageInfo = document.getElementById('languageInfo');
        const detectedLanguage = document.getElementById('detectedLanguage');
        
        // Ë®ÄË™ûÊ§úÂá∫Èñ¢Êï∞
        function detectLanguage(text) {
            const japanesePattern = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
            const englishPattern = /^[a-zA-Z0-9\s.,!?;:"'()\-\[\]{}@#$%^&*+=<>\/\\`~]*$/;

            if (japanesePattern.test(text)) {
                return 'ja';
            } else if (englishPattern.test(text.trim())) {
                return 'en';
            } else {
                // Ê∑∑Âú®„Åæ„Åü„ÅØ‰∏çÊòé„Å™Â†¥Âêà„ÅØÊó•Êú¨Ë™û„Çí„Éá„Éï„Ç©„É´„Éà
                return 'ja';
            }
        }

        // Ëã±Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂâçÂá¶ÁêÜÈñ¢Êï∞
        function preprocessEnglishText(text) {
            let processed = text;

            // Áï•Ë™û„ÅÆÂ±ïÈñã
            const abbreviations = {
                'Mr.': 'Mister',
                'Mrs.': 'Misses',
                'Ms.': 'Miss',
                'Dr.': 'Doctor',
                'Prof.': 'Professor',
                'St.': 'Street',
                'Ave.': 'Avenue',
                'Blvd.': 'Boulevard',
                'Inc.': 'Incorporated',
                'Co.': 'Company',
                'Ltd.': 'Limited',
                'etc.': 'etcetera',
                'vs.': 'versus',
                'e.g.': 'for example',
                'i.e.': 'that is',
                'U.S.': 'United States',
                'U.K.': 'United Kingdom',
                'U.S.A.': 'United States of America',
                'www.': 'W W W dot',
                '.com': ' dot com',
                '.org': ' dot org',
                '.net': ' dot net',
                '@': ' at '
            };

            // Áï•Ë™û„ÇíÂ±ïÈñã
            Object.keys(abbreviations).forEach(abbr => {
                const regex = new RegExp('\\b' + abbr.replace('.', '\\.'), 'gi');
                processed = processed.replace(regex, abbreviations[abbr]);
            });

            // URL„Å®„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÂá¶ÁêÜ
            processed = processed.replace(/https?:\/\//gi, 'H T T P ');
            processed = processed.replace(/\.([a-z]{2,4})\b/gi, ' dot $1');

            // Êï∞Â≠ó„ÅÆÂá¶ÁêÜ
            processed = processed.replace(/(\d+)\.(\d+)/g, '$1 point $2');

            // SSML„Çµ„Éù„Éº„Éà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Å®Êñá„ÅÆÂå∫Âàá„ÇäÊîπÂñÑ
            if (typeof window !== 'undefined' && window.speechSynthesis) {
                // „É¢„Éê„Ç§„É´Â∞ÇÁî®„ÅÆÂº∑ÂåñÂá¶ÁêÜ
                if (isMobile) {
                    // „Çπ„Éû„Éõ„Åß„ÅØ„Çà„ÇäÈï∑„ÅÑÈñì„ÇíËøΩÂä†ÔºàËá™ÁÑ∂„Å™Ë™≠„Åø‰∏ä„Åí„ÅÆ„Åü„ÇÅÔºâ
                    processed = processed.replace(/([.!?])\s+/g, '$1...... '); // Èï∑„ÇÅ„ÅÆÈñì
                    processed = processed.replace(/,\s+/g, ', .. '); // „Ç´„É≥„ÉûÂæå„Å´Áü≠„ÅÑÈñì
                    processed = processed.replace(/;\s+/g, '; ... '); // „Çª„Éü„Ç≥„É≠„É≥Âæå„Å´Èñì
                    processed = processed.replace(/:\s+/g, ': .. '); // „Ç≥„É≠„É≥Âæå„Å´Áü≠„ÅÑÈñì

                    // Èï∑„ÅÑÊñá„ÇíÂàÜÂâ≤Ôºà50-70ÊñáÂ≠ó„ÅßÂå∫Âàá„ÇäÔºâ
                    processed = splitLongSentencesForMobile(processed);
                } else {
                    // PCÁî®„ÅÆÊó¢Â≠òÂá¶ÁêÜ
                    processed = processed.replace(/([.!?])\s+/g, '$1... ');
                    processed = processed.replace(/,\s+/g, ', ');
                    processed = processed.replace(/;\s+/g, '; ');
                }
            }

            return processed;
        }

        // „Çπ„Éû„ÉõÁî®ÔºöÈï∑„ÅÑÊñáÁ´†„ÇíËá™ÁÑ∂„Å´ÂàÜÂâ≤„Åô„ÇãÈñ¢Êï∞
        function splitLongSentencesForMobile(text) {
            const sentences = text.split(/([.!?]+\s*)/);
            let processedSentences = [];

            for (let i = 0; i < sentences.length; i += 2) {
                const sentence = sentences[i];
                const punctuation = sentences[i + 1] || '';

                if (sentence && sentence.length > 70) {
                    // Èï∑„ÅÑÊñá„ÇíÂàÜÂâ≤
                    const parts = [];
                    let currentPart = '';
                    const words = sentence.split(' ');

                    for (const word of words) {
                        if (currentPart.length + word.length + 1 <= 60) {
                            currentPart += (currentPart ? ' ' : '') + word;
                        } else {
                            if (currentPart) {
                                parts.push(currentPart + ',');
                                currentPart = word;
                            } else {
                                parts.push(word);
                            }
                        }
                    }

                    if (currentPart) {
                        parts.push(currentPart);
                    }

                    // ÊúÄÂæå„ÅÆÈÉ®ÂàÜ„Å´Âè•Ë™≠ÁÇπ„ÇíËøΩÂä†
                    if (parts.length > 0) {
                        parts[parts.length - 1] += punctuation;
                    }

                    processedSentences.push(parts.join(' ... '));
                } else {
                    processedSentences.push(sentence + punctuation);
                }
            }

            return processedSentences.join(' ');
        }

        // Êó•Êú¨Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂâçÂá¶ÁêÜÈñ¢Êï∞
        function preprocessJapaneseText(text) {
            let processed = text;

            // Ë™≠„Åø„Åå„Å™Ê©üËÉΩÔºà‰æãÔºöÊù±‰∫¨[„Å®„ÅÜ„Åç„Çá„ÅÜ]Ôºâ
            processed = processed.replace(/([^\[\]]+)\[([^\[\]]+)\]/g, '$2');

            // Âè•Ë™≠ÁÇπ„ÅÆÂæå„Å´Èñì„ÇíËøΩÂä†
            processed = processed.replace(/„ÄÇ/g, '„ÄÇ„ÄÄ'); // ÂÖ®Ëßí„Çπ„Éö„Éº„Çπ
            processed = processed.replace(/„ÄÅ/g, '„ÄÅ '); // ÂçäËßí„Çπ„Éö„Éº„Çπ
            processed = processed.replace(/ÔºÅ/g, 'ÔºÅ„ÄÄ„ÄÄ'); // Èï∑„ÅÑÈñì
            processed = processed.replace(/Ôºü/g, 'Ôºü„ÄÄ„ÄÄ'); // Èï∑„ÅÑÈñì

            // ‰ºöË©±Êñá„ÅÆÊ§úÂá∫„Å®Âá¶ÁêÜ
            processed = processed.replace(/„Äå([^„Äç]+)„Äç/g, (match, content) => {
                return `„Äå ${content} „Äç`; // ‰ºöË©±Êñá„ÅÆÂâçÂæå„Å´„Çπ„Éö„Éº„Çπ
            });

            // Âº∑Ë™øË®òÊ≥ï„ÅÆÂá¶ÁêÜÔºà**text**Ôºâ
            processed = processed.replace(/\*\*([^*]+)\*\*/g, (match, content) => {
                return ` ${content} `; // Âº∑Ë™øÈÉ®ÂàÜ„ÅÆÂâçÂæå„Å´„Çπ„Éö„Éº„Çπ
            });

            // Êã¨ÂºßÂÜÖ„ÅÆÂá¶ÁêÜ
            processed = processed.replace(/Ôºà([^Ôºâ]+)Ôºâ/g, (match, content) => {
                return ` Ôºà${content}Ôºâ `; // Êã¨Âºß„ÅÆÂâçÂæå„Å´„Çπ„Éö„Éº„Çπ
            });

            // Êº¢Â≠ó„ÅÆÈÄ£Á∂ö„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÅÆ„Çπ„Éö„Éº„ÇπÊåøÂÖ•ÔºàÂÆüÈ®ìÁöÑÔºâ
            // Èï∑„ÅÑÊº¢Â≠óÂàó„ÅÆÈñì„Å´ÂæÆÂ∞è„Å™Èñì„ÇíËøΩÂä†
            processed = processed.replace(/([‰∏Ä-ÈæØ]{4,})/g, (match) => {
                return match.replace(/([‰∏Ä-ÈæØ]{2})([‰∏Ä-ÈæØ]{2})/g, '$1 $2');
            });

            // Êï∞Â≠ó„ÅÆË™≠„ÅøÊñπ„ÇíÊîπÂñÑ
            processed = processed.replace(/(\d+)Âπ¥/g, '$1„Å≠„Çì');
            processed = processed.replace(/(\d+)Êúà/g, '$1„Åå„Å§');
            processed = processed.replace(/(\d+)Êó•/g, '$1„Å´„Å°');
            processed = processed.replace(/(\d+)ÊôÇ/g, '$1„Åò');
            processed = processed.replace(/(\d+)ÂàÜ/g, '$1„Åµ„Çì');

            // ‰ΩôÂàÜ„Å™„Çπ„Éö„Éº„Çπ„ÇíÊï¥ÁêÜ
            processed = processed.replace(/\s+/g, ' ');
            processed = processed.trim();

            return processed;
        }

        // È´òÂìÅË≥™Èü≥Â£∞„ÅÆÂà§ÂÆö
        function getVoiceQuality(voice) {
            const highQualityProviders = ['Google', 'Microsoft', 'Apple', 'Amazon'];
            const isHighQuality = highQualityProviders.some(provider =>
                voice.name.includes(provider) || voice.voiceURI.includes(provider)
            );
            return isHighQuality ? '‚òÖ' : '';
        }

        // Èü≥Â£∞„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø
        function loadVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '<option value="">Ëá™ÂãïÈÅ∏Êäû</option>';

            // Èü≥Â£∞„ÇíÂàÜÈ°û
            const jpVoices = voices.filter(voice => voice.lang.includes('ja'))
                .sort((a, b) => getVoiceQuality(b).length - getVoiceQuality(a).length);
            const enVoices = voices.filter(voice => voice.lang.includes('en'))
                .sort((a, b) => getVoiceQuality(b).length - getVoiceQuality(a).length);
            const otherVoices = voices.filter(voice => !voice.lang.includes('ja') && !voice.lang.includes('en'));

            // Êó•Êú¨Ë™ûÈü≥Â£∞„ÇíËøΩÂä†
            if (jpVoices.length > 0) {
                const jpGroup = document.createElement('optgroup');
                jpGroup.label = 'Êó•Êú¨Ë™û';
                jpVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)} ${voice.name}`;
                    jpGroup.appendChild(option);
                });
                voiceSelect.appendChild(jpGroup);
            }

            // Ëã±Ë™ûÈü≥Â£∞„ÇíËøΩÂä†
            if (enVoices.length > 0) {
                const enGroup = document.createElement('optgroup');
                enGroup.label = 'English';
                enVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)} ${voice.name}`;
                    enGroup.appendChild(option);
                });
                voiceSelect.appendChild(enGroup);
            }

            // „Åù„ÅÆ‰ªñ„ÅÆÈü≥Â£∞„ÇíËøΩÂä†
            if (otherVoices.length > 0) {
                const otherGroup = document.createElement('optgroup');
                otherGroup.label = '„Åù„ÅÆ‰ªñ';
                otherVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    otherGroup.appendChild(option);
                });
                voiceSelect.appendChild(otherGroup);
            }
        }
        
        // ÂàùÂõûË™≠„ÅøËæº„Åø„Å®Êõ¥Êñ∞ÊôÇ„ÅÆÂá¶ÁêÜ
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
        
        // „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÊõ¥Êñ∞
        // ÈÄüÂ∫¶Â§âÊõ¥„ÅÆÂÖ±ÈÄöÂá¶ÁêÜÈñ¢Êï∞
        function handleRateChange() {
            rateValue.textContent = rateRange.value;
            updateActivePresetBtn('rate', rateRange.value);

            // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateSpeedDebugInfo();

            // „É™„Ç¢„É´„Çø„Ç§„É†ÈÄüÂ∫¶Â§âÊõ¥
            handleRealtimeParamChange();
        }

        // ÈÄüÂ∫¶„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„ÉàÔºàPC + „É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
        rateRange.addEventListener('input', handleRateChange);

        // „Çπ„Éû„ÉõÂ∞ÇÁî®„Ç§„Éô„É≥„Éà
        if (isMobile) {
            rateRange.addEventListener('change', handleRateChange);
            rateRange.addEventListener('touchend', () => {
                // touchendÂæå„Å´Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂá¶ÁêÜÔºàÂÄ§„ÅåÁ¢∫ÂÆö„Åô„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
                setTimeout(handleRateChange, 50);
            });
        }


        // „Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅÆÊ©üËÉΩ
        function updateActivePresetBtn(type, value) {
            const buttons = document.querySelectorAll(`[data-${type}]`);
            buttons.forEach(btn => {
                const btnValue = parseFloat(btn.getAttribute(`data-${type}`));
                if (Math.abs(btnValue - parseFloat(value)) < 0.01) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // ÈÄüÂ∫¶„Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.querySelectorAll('[data-rate]').forEach(btn => {
            btn.addEventListener('click', () => {
                const rate = btn.getAttribute('data-rate');
                rateRange.value = rate;

                // ÂÖ±ÈÄöÂá¶ÁêÜ„Çí‰ΩøÁî®Ôºà„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫„ÇÇÊõ¥Êñ∞„Åï„Çå„ÇãÔºâ
                handleRateChange();
            });
        });

        // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÊôÇ„ÅÆË®ÄË™ûÊ§úÂá∫„Å®„É™„Ç¢„É´„Çø„Ç§„É†Â§âÊõ¥Ê§úÁü•
        textInput.addEventListener('input', () => {
            const text = textInput.value.trim();

            // Ë™≠„Åø‰∏ä„Åí‰∏≠„Å´„ÉÜ„Ç≠„Çπ„Éà„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà
            if (isPlaying && originalText && text !== originalText) {
                synth.cancel();
                status.textContent = '„ÉÜ„Ç≠„Çπ„Éà„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü';
                resetButtons();
                originalText = '';
                allSentences = [];
                currentSentenceIndex = 0;
            }

            // Ë®ÄË™ûÊ§úÂá∫
            if (text) {
                const lang = detectLanguage(text);
                const langName = lang === 'ja' ? 'Êó•Êú¨Ë™û' : 'English';
                detectedLanguage.textContent = langName;
                languageInfo.style.display = 'block';
            } else {
                languageInfo.style.display = 'none';
            }
        });
        
        // „Çπ„Éû„ÉõÂ∞ÇÁî®„ÅÆËã±Ë™ûÈü≥Â£∞ÈÅ∏ÊäûÊ©üËÉΩ
        function getMobileOptimalEnglishVoice() {
            let englishVoices = voices.filter(voice =>
                voice.lang.includes('en') || voice.lang.toLowerCase().includes('english')
            );

            // „É¢„Éê„Ç§„É´„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÊó¢Â≠ò„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®
            if (!isMobile) {
                const highQualityVoices = englishVoices.filter(voice => getVoiceQuality(voice));
                return highQualityVoices.length > 0 ? highQualityVoices[0] : (englishVoices.length > 0 ? englishVoices[0] : null);
            }

            let selectedVoice = null;

            if (isIOS) {
                // iOSÂ∞ÇÁî®„ÅÆÈü≥Â£∞ÂÑ™ÂÖàÈ†Ü‰Ωç
                const iosPriorities = [
                    'Samantha',     // SiriÂ•≥ÊÄßÈü≥Â£∞
                    'Alex',         // Áî∑ÊÄßÈü≥Â£∞
                    'Daniel',       // „Ç§„ÇÆ„É™„ÇπËã±Ë™û
                    'Karen',        // „Ç™„Éº„Çπ„Éà„É©„É™„Ç¢Ëã±Ë™û
                    'Moira'         // „Ç¢„Ç§„É´„É©„É≥„ÉâËã±Ë™û
                ];

                // ÂÑ™ÂÖàÈ†Ü‰Ωç„Å´Âü∫„Å•„ÅÑ„Å¶Ê§úÁ¥¢
                for (const priority of iosPriorities) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.toLowerCase().includes(priority.toLowerCase()) ||
                        voice.voiceURI.toLowerCase().includes(priority.toLowerCase())
                    );
                    if (selectedVoice) break;
                }

                // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅcom.apple„ÇíÂê´„ÇÄÈü≥Â£∞„ÇíÊé¢„Åô
                if (!selectedVoice) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.voiceURI.includes('com.apple') || voice.name.includes('Apple')
                    );
                }
            } else if (isAndroid) {
                // AndroidÂ∞ÇÁî®„ÅÆÈü≥Â£∞ÂÑ™ÂÖàÈ†Ü‰Ωç
                const androidPriorities = [
                    'Google US English',
                    'Google UK English',
                    'Samsung'
                ];

                // ÂÑ™ÂÖàÈ†Ü‰Ωç„Å´Âü∫„Å•„ÅÑ„Å¶Ê§úÁ¥¢
                for (const priority of androidPriorities) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.includes(priority) || voice.voiceURI.includes(priority)
                    );
                    if (selectedVoice) break;
                }

                // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅGoogle„Åæ„Åü„ÅØÂêçÂâç„Å´English„ÇíÂê´„ÇÄÈü≥Â£∞„ÇíÊé¢„Åô
                if (!selectedVoice) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.includes('Google') && voice.name.includes('English')
                    );
                }

                if (!selectedVoice) {
                    selectedVoice = englishVoices.find(voice =>
                        voice.name.toLowerCase().includes('english')
                    );
                }
            }

            // Èü≥Â£∞„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆÂØæÁ≠ñ
            if (!selectedVoice) {
                // en-US„Åã„Çâen„Å´Â§âÊõ¥„Åó„Å¶ÂÜçË©¶Ë°å
                englishVoices = voices.filter(voice => voice.lang === 'en');
                selectedVoice = englishVoices.length > 0 ? englishVoices[0] : null;
            }

            // „Åæ„Å†Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅlocalService„Ååfalse„ÅÆÈü≥Â£∞Ôºà„Ç™„É≥„É©„Ç§„É≥Èü≥Â£∞Ôºâ„ÇíË©¶„Åô
            if (!selectedVoice) {
                const onlineVoices = voices.filter(voice =>
                    (voice.lang.includes('en') || voice.lang.toLowerCase().includes('english')) &&
                    voice.localService === false
                );
                selectedVoice = onlineVoices.length > 0 ? onlineVoices[0] : null;
            }

            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            updateVoiceDebugInfo(selectedVoice);

            return selectedVoice || (englishVoices.length > 0 ? englishVoices[0] : null);
        }

        // Èü≥Â£∞ÈÅ∏Êäû„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        function updateVoiceDebugInfo(voice) {
            const debugInfo = document.getElementById('voiceDebugInfo');
            const voiceName = document.getElementById('selectedVoiceName');

            if (voice && debugInfo && voiceName) {
                let deviceInfo = '';
                if (isIOS) deviceInfo = 'iOS';
                else if (isAndroid) deviceInfo = 'Android';
                else if (isMobile) deviceInfo = 'Mobile';
                else deviceInfo = 'PC';

                voiceName.textContent = `${voice.name} (${deviceInfo})`;
                debugInfo.style.display = 'block';

                // ÈÄüÂ∫¶„Å®„Éî„ÉÉ„ÉÅ„ÅÆÊÉÖÂ†±„ÇÇÊõ¥Êñ∞
                updateSpeedDebugInfo();
            }
        }

        // ÈÄüÂ∫¶„Éª„Éî„ÉÉ„ÉÅ„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        function updateSpeedDebugInfo() {
            const speedDebug = document.getElementById('currentSpeedDebug');
            const pitchDebug = document.getElementById('currentPitchDebug');
            const debugInfo = document.getElementById('voiceDebugInfo');

            if (speedDebug && pitchDebug) {
                const currentRate = rateRange.value;
                const currentPitch = pitchRange.value;

                // „Çπ„Éû„Éõ„ÅÆÂ†¥Âêà„ÅØÂÆüÈöõ„Å´ÈÅ©Áî®„Åï„Çå„ÇãÂÄ§„ÇÇË°®Á§∫
                if (isMobile) {
                    const detectedLang = detectLanguage(textInput.value.trim());
                    const actualParams = getMobileOptimizedParams(detectedLang, currentRate, currentPitch);
                    speedDebug.textContent = `${currentRate} ‚Üí ${actualParams.rate.toFixed(2)}`;
                    pitchDebug.textContent = `${currentPitch} ‚Üí ${actualParams.pitch.toFixed(2)}`;
                } else {
                    speedDebug.textContent = currentRate;
                    pitchDebug.textContent = currentPitch;
                }

                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫
                if (debugInfo) {
                    debugInfo.style.display = 'block';
                }
            }
        }

        // Ë™≠„Åø‰∏ä„Åí„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæóÔºà„Éî„ÉÉ„ÉÅ„ÅØÂõ∫ÂÆö1.0Ôºâ
        function getMobileOptimizedParams(detectedLang, baseRate) {
            if (!isMobile) {
                // PC„ÅÆÂ†¥Âêà„ÅØÊó¢Â≠ò„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ
                if (detectedLang === 'en') {
                    return {
                        rate: parseFloat(baseRate) * 0.9,
                        pitch: 1.0,
                        volume: 1.0
                    };
                } else {
                    return {
                        rate: parseFloat(baseRate),
                        pitch: 1.0,
                        volume: 1.0
                    };
                }
            }

            // „Çπ„Éû„ÉõÂ∞ÇÁî®„ÅÆË®≠ÂÆö
            if (detectedLang === 'en') {
                return {
                    rate: parseFloat(baseRate) * 0.95, // „Çπ„Éû„Éõ„ÅÆËã±Ë™û„ÅØ„É¶„Éº„Ç∂„ÉºË®≠ÂÆöÂÄ§„ÅÆ95%ÔºàÂ∞ë„ÅóËá™ÁÑ∂„Å´Ôºâ
                    pitch: 1.0,      // „Éî„ÉÉ„ÉÅ„ÅØÂõ∫ÂÆö
                    volume: 1.0
                };
            } else {
                // Êó•Êú¨Ë™û„Å™„Å©„ÅÆ‰ªñ„ÅÆË®ÄË™û
                return {
                    rate: parseFloat(baseRate),
                    pitch: 1.0,
                    volume: 1.0
                };
            }
        }

        // ÊúÄÈÅ©„Å™Èü≥Â£∞„ÇíËá™ÂãïÈÅ∏Êäû
        function getOptimalVoice(detectedLang) {
            let targetVoices;
            if (detectedLang === 'ja') {
                targetVoices = voices.filter(voice => voice.lang.includes('ja'));

                // Êó•Êú¨Ë™ûÈü≥Â£∞„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç
                const priorityOrder = [
                    'Google', // ÊúÄ„ÇÇËá™ÁÑ∂
                    'Microsoft Nanami',
                    'Microsoft Haruka',
                    'Apple Kyoko',
                    'Apple Otoya'
                ];

                // ÂÑ™ÂÖàÈ†Ü‰Ωç„Å´Âü∫„Å•„ÅÑ„Å¶Èü≥Â£∞„ÇíÈÅ∏Êäû
                for (const priority of priorityOrder) {
                    const preferredVoice = targetVoices.find(voice =>
                        voice.name.includes(priority) || voice.voiceURI.includes(priority)
                    );
                    if (preferredVoice) {
                        return preferredVoice;
                    }
                }
            } else if (detectedLang === 'en') {
                return getMobileOptimalEnglishVoice();
            } else {
                targetVoices = voices.filter(voice => voice.lang.includes('en'));

                // È´òÂìÅË≥™Èü≥Â£∞„ÇíÂÑ™ÂÖà
                const highQualityVoices = targetVoices.filter(voice => getVoiceQuality(voice));
                if (highQualityVoices.length > 0) {
                    return highQualityVoices[0];
                }
            }

            return targetVoices.length > 0 ? targetVoices[0] : null;
        }

        // Êó•Êú¨Ë™ûË™≠„Åø‰∏ä„Åí„Éë„É©„É°„Éº„Çø„ÅÆÊúÄÈÅ©Âåñ
        function getOptimizedJapaneseParams(text, baseRate, basePitch) {
            const textLength = text.length;
            let optimizedRate = baseRate;
            let optimizedPitch = basePitch;

            // ÊñáÁ´†„ÅÆÈï∑„Åï„Å´Âøú„Åò„Å¶rate„ÇíË™øÊï¥
            if (textLength < 30) {
                optimizedRate = Math.min(baseRate * 1.05, 0.9); // Áü≠Êñá„ÅØÂ∞ë„ÅóÈÄü„ÇÅ
            } else if (textLength > 100) {
                optimizedRate = Math.max(baseRate * 0.95, 0.85); // Èï∑Êñá„ÅØÂ∞ë„ÅóÈÅÖ„ÇÅ
            } else {
                optimizedRate = Math.max(baseRate * 0.95, 0.85); // ‰∏≠Êñá„ÅØÈÅÖ„ÇÅ
            }

            // „Ç§„É≥„Éà„Éç„Éº„Ç∑„Éß„É≥ÊîπÂñÑ
            if (text.includes('Ôºü') || text.includes('„Åß„Åô„Åã') || text.includes('„Åæ„Åô„Åã')) {
                // ÁñëÂïèÊñá„ÅÆÂ†¥Âêà„ÄÅ„Éî„ÉÉ„ÉÅ„ÇíÂ∞ë„Åó‰∏ä„Åí„Çã
                optimizedPitch = Math.min(basePitch * 1.05, 1.1);
            } else if (text.includes('ÔºÅ') || text.includes('„Åß„ÅôÔºÅ') || text.includes('„Åæ„ÅôÔºÅ')) {
                // ÊÑüÂòÜÊñá„ÅÆÂ†¥Âêà„ÄÅ„Éî„ÉÉ„ÉÅ„ÇíÈ´ò„Åè„ÄÅ„Çπ„Éî„Éº„Éâ„ÇíÂ∞ë„ÅóÈÄü„Åè
                optimizedPitch = Math.min(basePitch * 1.1, 1.15);
                optimizedRate = Math.min(optimizedRate * 1.05, 0.95);
            } else {
                // ÈÄöÂ∏∏„ÅÆÊñá„ÅØËá™ÁÑ∂„Å™ÊäëÊèö
                optimizedPitch = Math.max(Math.min(basePitch, 1.05), 0.95);
            }

            return { rate: optimizedRate, pitch: optimizedPitch };
        }

        // Ë™≠„Åø‰∏ä„Åí/‰∏ÄÊôÇÂÅúÊ≠¢Ê©üËÉΩ
        playPauseBtn.addEventListener('click', () => {
            // ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„ÅÆÂ†¥Âêà„ÅØÂÜçÈñã
            if (isPaused) {
                synth.resume();
                isPaused = false;
                updatePlayPauseButton(true);
                status.textContent = 'Ë™≠„Åø‰∏ä„Åí‰∏≠...';
                return;
            }

            // ÂÜçÁîü‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰∏ÄÊôÇÂÅúÊ≠¢
            if (isPlaying && synth.speaking) {
                synth.pause();
                isPaused = true;
                updatePlayPauseButton(false);
                status.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠...';
                return;
            }
            const text = textInput.value.trim();

            if (!text) {
                status.textContent = '„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                return;
            }

            // Êó¢Â≠ò„ÅÆË™≠„Åø‰∏ä„Åí„ÇíÂÅúÊ≠¢
            synth.cancel();
            isPaused = false;
            currentPosition = 0;

            // Ë®ÄË™ûÊ§úÂá∫
            const detectedLang = detectLanguage(text);

            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂâçÂá¶ÁêÜ
            let processedText = text;
            if (detectedLang === 'en') {
                processedText = preprocessEnglishText(text);
            } else if (detectedLang === 'ja') {
                processedText = preprocessJapaneseText(text);
            }

            currentText = processedText;
            originalText = text; // „É™„Ç¢„É´„Çø„Ç§„É†Â§âÊõ¥Ê§úÁü•Áî®

            // Êó•Êú¨Ë™û„ÅÆÂ†¥Âêà„ÅØÊñáÁ´†ÂàÜÂâ≤„Åó„Å¶Ëá™ÁÑ∂„Å™Èñì„Çí‰Ωú„Çã
            if (detectedLang === 'ja') {
                speakJapaneseWithPauses(processedText);
                return;
            }

            // Ëã±Ë™û„Åù„ÅÆ‰ªñ„ÅÆË®ÄË™û„ÅÆÂæìÊù•Âá¶ÁêÜ
            const utterance = new SpeechSynthesisUtterance(processedText);
            currentUtterance = utterance;

            // Èü≥Â£∞„ÅÆÈÅ∏Êäû
            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== '' && voices[selectedIndex]) {
                utterance.voice = voices[selectedIndex];
            } else {
                // Ëá™ÂãïÈÅ∏Êäû
                const optimalVoice = getOptimalVoice(detectedLang);
                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                }
            }

            // Ë®ÄË™ûÂà•„Éë„É©„É°„Éº„Çø„ÅÆÊúÄÈÅ©ÂåñÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
            const optimizedParams = getMobileOptimizedParams(detectedLang, rateRange.value);
            utterance.rate = optimizedParams.rate;
            utterance.pitch = 1.0;
            utterance.volume = optimizedParams.volume;

        // Êó•Êú¨Ë™ûÊñáÁ´†ÂàÜÂâ≤Ë™≠„Åø‰∏ä„ÅíÊ©üËÉΩ
        function speakJapaneseWithPauses(text) {
            // ÊñáÁ´†„ÇíÂè•ÁÇπ„Å®ÊÆµËêΩ„ÅßÂàÜÂâ≤
            allSentences = text.split(/([„ÄÇÔºÅÔºü]|\n\n+)/).filter(s => s.trim());
            currentSentenceIndex = 0;
            originalText = text;

            // Â±•Ê≠¥„Å´‰øùÂ≠ò
            saveToHistory(text, 'ja', rateRange.value);

            speakJapaneseFromIndex(0);
        }

        function speakJapaneseFromIndex(startIndex) {
            currentSentenceIndex = startIndex;

            function speakNextSentence() {
                if (currentSentenceIndex >= allSentences.length) {
                    status.textContent = 'Ë™≠„Åø‰∏ä„ÅíÂÆå‰∫Ü';
                    resetButtons();
                    return;
                }

                const sentence = allSentences[currentSentenceIndex].trim();
                currentSentenceIndex++;

                // Á©∫„ÅÆÊñá„ÇÑÂå∫Âàá„ÇäÊñáÂ≠ó„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (!sentence || /^[„ÄÇÔºÅÔºü\s]*$/.test(sentence)) {
                    // ÊÆµËêΩÂàá„ÇäÊõø„Åà„ÅÆÂ†¥Âêà„ÅØ500msÂæÖÊ©ü
                    if (sentence.includes('\n')) {
                        setTimeout(speakNextSentence, 500);
                    } else {
                        speakNextSentence();
                    }
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(sentence);
                currentUtterance = utterance;

                // Èü≥Â£∞ÈÅ∏Êäû
                const selectedIndex = voiceSelect.value;
                if (selectedIndex !== '' && voices[selectedIndex]) {
                    utterance.voice = voices[selectedIndex];
                } else {
                    const optimalVoice = getOptimalVoice('ja');
                    if (optimalVoice) {
                        utterance.voice = optimalVoice;
                    }
                }

                // Êó•Êú¨Ë™ûÊúÄÈÅ©Âåñ„Éë„É©„É°„Éº„Çø„ÇíÈÅ©Áî®
                const baseRate = parseFloat(rateRange.value);
                const basePitch = parseFloat(pitchRange.value);
                const optimized = getOptimizedJapaneseParams(sentence, baseRate, basePitch);

                utterance.rate = optimized.rate;
                utterance.pitch = optimized.pitch;
                utterance.volume = 1.0;

                // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
                utterance.onstart = () => {
                    if (currentSentenceIndex === 1) {
                        status.textContent = 'Ë™≠„Åø‰∏ä„Åí‰∏≠...';
                        updatePlayPauseButton(true);
                        playPauseBtn.disabled = false;
                        skipBackBtn.disabled = false;
                        skipForwardBtn.disabled = false;
                    }
                };

                utterance.onend = () => {
                    // Êñá„Å®Êñá„ÅÆÈñì„Å´300ms„ÄÅÊÆµËêΩ„ÅÆÈñì„Å´500ms„ÅÆËá™ÁÑ∂„Å™Èñì„ÇíËøΩÂä†
                    const nextSentence = allSentences[currentSentenceIndex];
                    const pauseDuration = (nextSentence && nextSentence.includes('\n')) ? 500 : 300;

                    setTimeout(speakNextSentence, pauseDuration);
                };

                utterance.onerror = () => {
                    status.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    resetButtons();
                };

                synth.speak(utterance);
            }

            speakNextSentence();
        }

            // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
            utterance.onstart = () => {
                status.textContent = 'Ë™≠„Åø‰∏ä„Åí‰∏≠...';
                updatePlayPauseButton(true);
                playPauseBtn.disabled = false;
                skipBackBtn.disabled = false;
                skipForwardBtn.disabled = false;
            };

            utterance.onend = () => {
                status.textContent = 'Ë™≠„Åø‰∏ä„ÅíÂÆå‰∫Ü';
                resetButtons();
            };

            utterance.onerror = () => {
                status.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                resetButtons();
            };

            // Â±•Ê≠¥„Å´‰øùÂ≠ò
            saveToHistory(text, detectedLang, rateRange.value);

            // Ë™≠„Åø‰∏ä„ÅíÈñãÂßã
            synth.speak(utterance);
        });
        

        // ÂÅúÊ≠¢Ê©üËÉΩ
        stopBtn.addEventListener('click', () => {
            synth.cancel();
            status.textContent = 'ÂÅúÊ≠¢„Åó„Åæ„Åó„Åü';
            resetButtons();
        });
        
        // ÂàùÊúüÁä∂ÊÖã„ÅÆË®≠ÂÆö
        skipBackBtn.disabled = true;
        skipForwardBtn.disabled = true;

        // „Çπ„Ç≠„ÉÉ„ÉóÊ©üËÉΩ
        function skipText(seconds, direction) {
            if (!currentText) return;

            const words = currentText.split(/\s+/);
            const wordsPerSecond = 2.5; // Âπ≥ÂùáÁöÑ„Å™Ë™≠„Åø‰∏ä„ÅíÈÄüÂ∫¶
            const skipWords = Math.floor(seconds * wordsPerSecond);

            if (direction === 'forward') {
                currentPosition = Math.min(currentPosition + skipWords, words.length);
            } else {
                currentPosition = Math.max(currentPosition - skipWords, 0);
            }

            if (synth.speaking) {
                synth.cancel();
                const remainingText = words.slice(currentPosition).join(' ');
                if (remainingText) {
                    speakFromPosition(remainingText);
                } else {
                    status.textContent = 'Ë™≠„Åø‰∏ä„ÅíÂÆå‰∫Ü';
                    resetButtons();
                }
            }
        }

        function speakFromPosition(text) {
            if (!text.trim()) return;

            const utterance = new SpeechSynthesisUtterance(text);
            currentUtterance = utterance;

            // Èü≥Â£∞Ë®≠ÂÆö„ÇíÈÅ©Áî®
            const selectedIndex = voiceSelect.value;
            if (selectedIndex !== '' && voices[selectedIndex]) {
                utterance.voice = voices[selectedIndex];
            } else {
                const detectedLang = detectLanguage(text);
                const optimalVoice = getOptimalVoice(detectedLang);
                if (optimalVoice) {
                    utterance.voice = optimalVoice;
                }
            }

            const detectedLang = detectLanguage(text);
            if (detectedLang === 'en') {
                utterance.rate = parseFloat(rateRange.value) * 0.9;
                utterance.pitch = 1.0;
            } else {
                utterance.rate = parseFloat(rateRange.value);
                utterance.pitch = 1.0;
            }

            utterance.onstart = () => {
                status.textContent = 'Ë™≠„Åø‰∏ä„Åí‰∏≠...';
                updatePlayPauseButton(true);
                playPauseBtn.disabled = false;
                skipBackBtn.disabled = false;
                skipForwardBtn.disabled = false;
            };

            utterance.onend = () => {
                status.textContent = 'Ë™≠„Åø‰∏ä„ÅíÂÆå‰∫Ü';
                resetButtons();
            };

            utterance.onerror = () => {
                status.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                resetButtons();
            };

            synth.speak(utterance);
        }

        function resetButtons() {
            updatePlayPauseButton(false);
            playPauseBtn.disabled = false;
            skipBackBtn.disabled = true;
            skipForwardBtn.disabled = true;
            currentUtterance = null;
            isPaused = false;
            currentPosition = 0;

            // „É™„Ç¢„É´„Çø„Ç§„É†Â§âÊõ¥Áî®Â§âÊï∞„ÇÇ„É™„Çª„ÉÉ„Éà
            isRealTimeChanging = false;
        }

        // „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        skipBackBtn.addEventListener('click', () => {
            skipText(15, 'backward');
        });

        skipForwardBtn.addEventListener('click', () => {
            skipText(15, 'forward');
        });

        // „Éñ„É©„Ç¶„Ç∂ÂØæÂøú„ÉÅ„Çß„ÉÉ„ÇØ
        if (!('speechSynthesis' in window)) {
            alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞ÂêàÊàê„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
            playPauseBtn.disabled = true;
        }

        // ‰æãÊñá„Éú„Çø„É≥„ÅÆÊ©üËÉΩ
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-text');

                // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´‰æãÊñá„ÇíÂÖ•Âäõ
                textInput.value = text;

                // „ÇØ„É™„ÉÉ„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                btn.classList.add('clicked');
                setTimeout(() => {
                    btn.classList.remove('clicked');
                }, 200);

                // Ë®ÄË™ûÊ§úÂá∫„Çí„Éà„É™„Ç¨„Éº
                const event = new Event('input', { bubbles: true });
                textInput.dispatchEvent(event);

                // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Çπ„ÇØ„É≠„Éº„É´
                textInput.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Éï„Ç©„Éº„Ç´„Çπ
                setTimeout(() => {
                    textInput.focus();
                }, 300);
            });
        });

        // ÂàùÊúüÂåñÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÊúü„ÅÆ„Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateSpeedDebugInfo();

            // „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„Çπ„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫
            if (isMobile) {
                const debugInfo = document.getElementById('voiceDebugInfo');
                if (debugInfo) {
                    debugInfo.style.display = 'block';
                }
            }

            // Â±•Ê≠¥Èñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const historyBtn = document.getElementById('historyBtn');
            const closeHistoryBtn = document.getElementById('closeHistoryModal');
            const historyModal = document.getElementById('historyModal');
            const clearAllBtn = document.getElementById('clearAllHistoryBtn');

            if (historyBtn) {
                historyBtn.addEventListener('click', openHistoryModal);
            }

            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener('click', closeHistoryModal);
            }

            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', () => {
                    if (confirm('„Åô„Åπ„Å¶„ÅÆÂ±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                        clearHistory();
                        displayHistory();
                    }
                });
            }

            // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            if (historyModal) {
                historyModal.addEventListener('click', (e) => {
                    if (e.target === historyModal) {
                        closeHistoryModal();
                    }
                });
            }

            // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && historyModal.style.display === 'flex') {
                    closeHistoryModal();
                }
            });
        });

        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service WorkerÁôªÈå≤ÊàêÂäü:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service WorkerÁôªÈå≤Â§±Êïó:', error);
                    });
            });
        }
    </script>
</body>
</html>
